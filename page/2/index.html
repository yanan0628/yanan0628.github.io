<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="study for goal">
<meta property="og:type" content="website">
<meta property="og:title" content="Meteor">
<meta property="og:url" content="/page/2/index.html">
<meta property="og:site_name" content="Meteor">
<meta property="og:description" content="study for goal">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Meteor">
<meta name="twitter:description" content="study for goal">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Meteor </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Meteor</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/30/10.5)  kubernetes基础使用介绍/" itemprop="url">
                  kubernetes基础介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-30T10:00:00+08:00" content="2017-10-30">
              2017-10-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/微服务/" itemprop="url" rel="index">
                    <span itemprop="name">微服务</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/微服务/springcloud/" itemprop="url" rel="index">
                    <span itemprop="name">springcloud</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://www.kubernetes.org.cn/%E6%96%87%E6%A1%A3%E4%B8%8B%E8%BD%BD" target="_blank" rel="external">kubernetes资料文档</a><br><a href="http://omerio.com/2015/12/18/learn-the-kubernetes-key-concepts-in-10-minutes/" target="_blank" rel="external">kubernetes概念介绍</a><br><a href="http://docs.kubernetes.org.cn/227.html" target="_blank" rel="external">kubernetes中文文档</a><br><a href="https://github.com/kubernetes/minikube" target="_blank" rel="external">minikube</a><br><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="external">kubernetes dashboard</a><br><a href="http://www.infoq.com/cn/news/2017/04/2017-Serverless" target="_blank" rel="external">Serverless无服务化</a></p>
<h2 id="什么是Kubernetes？"><a href="#什么是Kubernetes？" class="headerlink" title="什么是Kubernetes？"></a>什么是Kubernetes？</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Kubernetes（k8s）是自动化容器操作的开源平台，这些操作包括部署，调度和节点集群间扩展。如果你</div><div class="line">曾经用过Docker容器技术部署容器，那么可以将Docker看成Kubernetes内部使用的低级别组件。</div><div class="line">Kubernetes不仅仅支持Docker，还支持Rocket，这是另一种容器技术。</div><div class="line">使用Kubernetes可以：</div><div class="line">	&gt;自动化容器的部署和复制</div><div class="line">	&gt;随时扩展或收缩容器规模</div><div class="line">	&gt;将容器组织成组，并且提供容器间的负载均衡</div><div class="line">	&gt;很容易地升级应用程序容器的新版本</div><div class="line">	&gt;提供容器弹性，如果容器失效就替换它，等等...</div></pre></td></tr></table></figure>
<p>实际上，使用Kubernetes只需一个部署文件，使用一条命令就可以部署多层容器（前端，后台等）的完整集群：<a href="https://github.com/kubernetes/kubernetes/blob/master/examples/guestbook/all-in-one/guestbook-all-in-one.yaml" target="_blank" rel="external">部署文件</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ kubectl create -f single-config-file.yaml</div></pre></td></tr></table></figure>
<p>kubectl是和Kubernetes API交互的命令行程序。</p>
<h2 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h2><p>集群是一组节点，这些节点可以是物理服务器或者虚拟机，之上安装了Kubernetes平台。<br><img src="http://dockerone.com/uploads/article/20151230/d56441427680948fb56a00af57bda690.png" alt=""></p>
<p>上图可以看到如下组件，使用特别的图标表示Service和Label：</p>
<ul>
<li>Pod:直译豆子,包含一组容器和卷.</li>
<li>Container（容器）:</li>
<li>Label(label)（<img src="http://omerio.com/wp-content/uploads/2015/12/label.png" alt="">标签）</li>
<li>Replication Controller（<img src="http://omerio.com/wp-content/uploads/2015/12/service.png" alt="标签">复制控制器）</li>
<li>Service（enter image description here）（服务）</li>
<li>Node（节点）</li>
<li>Kubernetes Master（Kubernetes主节点）</li>
</ul>
<h3 id="kubernetes-deployment"><a href="#kubernetes-deployment" class="headerlink" title="kubernetes deployment"></a>kubernetes deployment</h3><p><code>Kubernetes Deployment</code>负责创建和更新应用。master节点会将Deployment创建好的应用实例调度到集群中的各个节点。<br><code>Kubernetes Deployment Controller</code>会持续监视这些实例。如果管理实例的节点被关闭或删除，那么 Deployment Controller将会替换它们，实现自我修复能力.<br><img src="https://d33wubrfki0l68.cloudfront.net/3854a4db66ad3dd4ede078865eff41510eeba7c0/33ac5/docs/tutorials/kubernetes-basics/public/images/module_02_first_app.svg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">localhos:kubernetes.io root# kubectl cluster-info</div><div class="line">Kubernetes master is running at https://192.168.99.100:8443</div></pre></td></tr></table></figure>
<h3 id="kubernetes-pod"><a href="#kubernetes-pod" class="headerlink" title="kubernetes pod"></a>kubernetes pod</h3><p><code>Pod</code>是Kubernetes中一个抽象化概念，由一个或多个容器组合在一起得共享资源。Pod是Kubernetes中的最小单位,Pod负责托管master节点的创建的deployment。Pod中的容器共享IP地址和端口。<br>在节点出现故障的情况下，master(RC Replication Controller)会将群集中的其他可用节点上将会调度之前相同的Pod。</p>
<ul>
<li>共享存储，如 Volumes 卷（Pod是短暂，持久化卷类型volume解决持久化容器数据）</li>
<li>网络，唯一的集群IP地址。（应用程序的“逻辑主机”,重启时IP地址可能会改变,这时可以使用Service）</li>
<li>每个容器运行的信息，例如:容器镜像版本</li>
</ul>
<p><img src="https://d33wubrfki0l68.cloudfront.net/fe03f68d8ede9815184852ca2a4fd30325e5d15a/98064/docs/tutorials/kubernetes-basics/public/images/module_03_pods.svg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubectl get - 列出资源</div><div class="line">kubectl describe - 显示资源的详细信息</div><div class="line">kubectl logs - 打印pod中的容器日志</div><div class="line">kubectl exec - pod中容器内部执行命令</div></pre></td></tr></table></figure>
<h3 id="kubernetes-node"><a href="#kubernetes-node" class="headerlink" title="kubernetes node"></a>kubernetes node</h3><p>一个Pod总是在一个（Node）节点上运行，Node是Kubernetes中的工作节点，可以是虚拟机或物理机。每个Node由 Master管理，Node上可以有多个pod，Kubernetes Master会自动处理群集中Node的pod调度，同时Master的自动调度会考虑每个Node上的可用资源。</p>
<p>每个Kubernetes Node上至少运行着：            </p>
<ul>
<li>Kubelet，管理Kubernetes Master和Node之间的通信; 管理机器上运行的Pods和containers容器。</li>
<li>container runtime（如Docker，rkt）</li>
</ul>
<p><img src="https://d33wubrfki0l68.cloudfront.net/5cb72d407cbe2755e581b6de757e0d81760d5b86/a9df9/docs/tutorials/kubernetes-basics/public/images/module_03_nodes.svg" alt=""></p>
<h3 id="Label-（-）"><a href="#Label-（-）" class="headerlink" title="Label （?）"></a>Label （?）</h3><p>一个Label是attach到Pod的一对键/值对，用来传递用户定义的属性。<br>创建了一个”tier”和“app”标签，通过Label（tier=frontend, app=myapp）来标记前端Pod容器，使用Label（tier=backend, app=myapp）标记后台Pod。Selectors选择带有特定Label的Pod，并且将Service或者Replication Controller应用到上面.</p>
<h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><p>Replication Controller确保任意时间都有指定数量的Pod“副本”在运行.如果为某个Pod创建了Replication Controller并且指定3个副本，它会创建3个Pod，并且持续监控它们。如果某个Pod不响应，那么Replication Controller会替换它，保持总数为3.</p>
<p>当创建Replication Controller时，需要指定两个东西：</p>
<ul>
<li>Pod模板：用来创建Pod副本的模板</li>
<li>Label：Replication Controller需要监控的Pod的标签。</li>
</ul>
<p><img src="http://dockerone.com/uploads/article/20151230/5e2bad1a25e33e2d155da81da1d3a54b.gif" alt=""></p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>rc创建多个pod副本上如何均衡负载呢？我们需要的是Service!</p>
<p>如果Pods是短暂的，那么重启时IP地址可能会改变，怎么才能从前端容器正确可靠地指向后台容器呢？<br>Service是定义<code>一系列Pod以及访问这些Pod的策略的一层抽象</code>。Service通过Label找到Pod组。<br>因为Service是抽象的，所以在图表里通常看不到它们的存在.</p>
<h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><h2 id="Kubectl-命令管理工具"><a href="#Kubectl-命令管理工具" class="headerlink" title="Kubectl 命令管理工具"></a>Kubectl 命令管理工具</h2><ul>
<li>获取有关Deployment的应用及其环境信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubectl get - 列出资源</div><div class="line">kubectl describe - 显示资源的详细信息</div><div class="line">kubectl logs - 打印pod中的容器日志</div><div class="line">kubectl exec - pod中容器内部执行命令</div></pre></td></tr></table></figure>
<h2 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">localhos:~ root# minikube stop （停止）</div><div class="line">Stopping local Kubernetes cluster...</div><div class="line">Machine stopped.</div><div class="line">localhos:~ root# minikube start</div><div class="line">Starting local Kubernetes v1.8.0 cluster...</div><div class="line">Starting VM...</div><div class="line">Getting VM IP address...</div><div class="line">Moving files into cluster...</div><div class="line">Setting up certs...</div><div class="line">Connecting to cluster...</div><div class="line">Setting up kubeconfig...</div><div class="line">Starting cluster components...</div><div class="line">Kubectl is now configured to use the cluster.</div><div class="line">localhos:~ root# minikube status</div><div class="line">minikube: Running</div><div class="line">cluster: Running</div><div class="line">kubectl: Correctly Configured: pointing to minikube-vm at 192.168.99.100</div></pre></td></tr></table></figure>
<p>/var/root/.minikube</p>
<p>/var/root/.kube</p>
<h2 id="问题收集"><a href="#问题收集" class="headerlink" title="问题收集"></a>问题收集</h2><ul>
<li>1.docker与kubernetes关系</li>
</ul>
<p><img src="https://www.kubernetes.org.cn/img/2016/11/20161107161910.jpg" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/30/10.5) kubernetes 资源归档/" itemprop="url">
                  kubernetes资源归档
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-30T10:00:00+08:00" content="2017-10-30">
              2017-10-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="">1.kubernetes介绍</a></li>
<li><a href="">2.kubernetes相关组件介绍</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/30/10.6) kubernetes相关组件介绍/" itemprop="url">
                  kube-proxy负载均衡策略
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-30T10:00:00+08:00" content="2017-10-30">
              2017-10-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2><p><img src="http://i3.itc.cn/20171116/aac_eafd764b_de5f_19c0_6113_50b0e652c842_1.png" alt=""></p>
<p><img src="http://i1.itc.cn/20171116/aac_2a52ef0f_180e_bb80_1551_0ede2c2f4a55_1.png" alt=""></p>
<h2 id="组件概念"><a href="#组件概念" class="headerlink" title="组件概念"></a>组件概念</h2><ul>
<li><p><code>1.etcd组件</code>:保存了整个集群的状态，CoreOS基于Raft开发的分布式key-value存储，可用于服务发现、共享配置以及 一致性保障(如数据库选主、分布式锁等)</p>
<p>  Etcd 和 Zookeeper 提供的是分布式一致性存储 能力，具体的业务场景需要用户自己实现，比如服务发现，比如配置变更。Consul:则以服务发现和配置变更为主要目标，同时附带了kv存储.</p>
  <image src="http://i3.itc.cn/20171116/aac_2a52ef0f_180e_bb80_1551_0ede2c2f4a55_2.png" width="200" height="240">

<ul>
<li>k-v存储（node pod 信息?）</li>
<li>watch key过期机制(变更通知和分发)</li>
</ul>
</image></li>
</ul>
<pre><code>redis 集群选举(纪元 任期+1)
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Cluster epoch:在slave升级为master中起重要作用</div><div class="line">config epoch:每次configEpoch改变都存储在nodes conf文件.</div><div class="line"></div><div class="line">10.10.88.200:6401&gt; cluster info</div><div class="line">cluster_known_nodes:6</div><div class="line">cluster_size:3</div><div class="line">cluster_current_epoch:4</div><div class="line">cluster_my_epoch:1</div><div class="line"></div><div class="line">10.10.88.202:6397&gt; cluster info</div><div class="line">cluster_known_nodes:6</div><div class="line">cluster_size:3</div><div class="line">cluster_current_epoch:4</div><div class="line">cluster_my_epoch:4</div></pre></td></tr></table></figure>
</code></pre><ul>
<li><p><code>2.apiserver</code>:提供了资源操作的唯一入口,并提供认证、授权、访问控制、API注册和 发现等机制;</p>
</li>
<li><p><code>3.controller manager</code>:负责维护集群的状态，比如故障检测、自动扩展、滚动更新等,包含像relication controller复制控制器(rs)、replicate set副本集(rc) 等;</p>
</li>
<li><p><code>4.kube-scheduler</code>：负责资源的调度，按照预定的调度策略将Pod调度到相应的机器上;</p>
<p>  kube-scheduler调度分为两个阶段，predicate和priority</p>
<ul>
<li>predicate:过滤不符合条件的节点</li>
<li>priority:优先级排序，选择优先级最高的节点</li>
</ul>
</li>
<li><p><code>5.kube-proxy</code>:每台机器上都运行一个kube-proxy服务，它监听API server中service和endpoint的变化 情况，并通过iptables等来为服务配置负载均衡(仅支持TCP和UDP)，负责为service提供cluster内部的服务发现和负载均衡(默认iptable)</p>
</li>
<li><p><code>6.kubelet</code>:每个节点上都运行一个kubelet服务进程，默认监听10250端口，接收并执行master发来 的指令，管理Pod及Pod中的容器，负责容器的生命周期，持久化卷volume(cvi)和网络(cni）</p>
</li>
<li><p><code>7.kube-dns</code>：负责为整个集群提供DNS服务</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/26/9.7)redis热点key问题排查/" itemprop="url">
                  redis 热点key排查
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-26T11:00:35+08:00" content="2017-10-26">
              2017-10-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="网络输入-输出流量问题排查"><a href="#网络输入-输出流量问题排查" class="headerlink" title="网络输入/输出流量问题排查"></a>网络输入/输出流量问题排查</h2><h3 id="流量影响"><a href="#流量影响" class="headerlink" title="流量影响"></a>流量影响</h3><p>现在公司用的是千兆网卡(bit)，换算流量最大阈值125MB左右，如果当前机器网络流量过大(redis在数据流入/流出会消耗大量流量)，当出现打满机器的网卡流量，就会造成当前机器的丢包或拥塞。会影响当前机器所有redis实例的访问和结果返回。</p>
<p>有以下几种情况:</p>
<ul>
<li>bigkey大对象,慢查询分析.比如:每秒50次get操作1M的对象（输出流量 50M/s）</li>
<li>ops暴增，比如:正常ops get操作200次,突然增到2000甚至更高,流量*10倍</li>
<li>ops增长不明显,慢查询也没有.可能有热点key流量都访问该redis实例(检查ops和instantaneous_output_kbps情况)</li>
</ul>
<h3 id="排查步骤"><a href="#排查步骤" class="headerlink" title="排查步骤"></a>排查步骤</h3><ul>
<li>1.先看应用是否有慢查询,大对象访问造成流量过高  </li>
<li>2.当前redis命令ops(如果是cluster 对比其他master节点)  </li>
<li>3.热点key分析  到服务器本地执行最近1分钟monitor命令  </li>
<li>4.facebook工具或脚本分析当前 热点command以及热点key</li>
<li>5.按ip 频次 key进行排序</li>
<li>6.计算每个ip key 对应流量 value*频次 </li>
<li>7.提供给客户端排查key 客户端ip 占用流量情况</li>
</ul>
<h3 id="工具排查"><a href="#工具排查" class="headerlink" title="工具排查"></a>工具排查</h3><ul>
<li><p>执行monitor命令导出文件</p>
</li>
<li><p>执行facebook脚本</p>
</li>
</ul>
<p><code>redis-faina.py</code>脚本:<a href="https://github.com/facebookarchive/redis-faina" target="_blank" rel="external">redis-faina使用方法</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">localhos:log chenshi$ ./redis-faina.py 78.41:6382.log</div><div class="line">Overall Stats</div><div class="line">========================================</div><div class="line">Lines Processed  	33072</div><div class="line">Commands/Sec     	1203.72</div><div class="line"></div><div class="line">Top Prefixes</div><div class="line">========================================</div><div class="line">m             	9480	(28.66%)</div><div class="line">p             	7963	(24.08%)</div><div class="line">pcl           	4511	(13.64%)</div><div class="line">card          	3468	(10.49%)</div><div class="line">catecodeinfo  	1698	(5.13%)</div><div class="line">pclcates      	257 	(0.78%)</div><div class="line">pcluser       	150 	(0.45%)</div><div class="line">pclcatef      	129 	(0.39%)</div><div class="line"></div><div class="line">Top Keys</div><div class="line">========================================</div><div class="line">m:pcl:pad:fircate:73  	8159	(24.67%)</div><div class="line">catecodeinfo:tag:v2   	1698	(5.13%)</div><div class="line">card:56:92655095,2    	1007	(3.04%)</div><div class="line">card:56:92400031,2    	879 	(2.66%)</div><div class="line">pcl:pad:seccate:60    	578 	(1.75%)</div><div class="line">pcl:pad:seccate:82    	541 	(1.64%)</div><div class="line">p:v:ee:92469530,2     	518 	(1.57%)</div><div class="line">p:s:sort:20171025:22  	426 	(1.29%)</div><div class="line"></div><div class="line">Top Commands</div><div class="line">========================================</div><div class="line">GET      	29435	(89.00%)</div><div class="line">SETEX    	3411 	(10.31%)</div><div class="line">TTL      	217  	(0.66%)</div><div class="line">HGETALL  	8    	(0.02%)</div><div class="line"></div><div class="line">Command Time (microsecs)</div><div class="line">========================================</div><div class="line">Median  	432.75</div><div class="line">75%     	1079.0</div><div class="line">90%     	2150.0</div><div class="line">99%     	5313.0</div><div class="line"></div><div class="line">Heaviest Commands (microsecs)</div><div class="line">========================================</div><div class="line">GET      	23233082.75</div><div class="line">SETEX    	3999394.75</div><div class="line">TTL      	229730.25</div><div class="line">HGETALL  	12561.25</div><div class="line"></div><div class="line">Slowest Calls</div><div class="line">========================================</div><div class="line">17639.0   	&quot;GET&quot; &quot;RVF#93579800,2&quot;</div><div class="line">16154.0   	&quot;SETEX&quot; &quot;p:v:ms:90570158,2&quot; &quot;86400&quot; &quot;2.5&quot;</div><div class="line">16146.0   	&quot;GET&quot; &quot;m:pcl:pad:topic:12540&quot;</div><div class="line">15166.0   	&quot;SETEX&quot; &quot;RG#93445677#2&quot; &quot;86400&quot; &quot;[&#123;\&quot;name\&quot;:\&quot;93445677,2\&quot;,\&quot;score\&quot;:0.01129842,\&quot;tag\&quot;:\&quot;\xe6\xbe\xa1\xe5\xa0\x82\&quot;&#125;]&quot;</div><div class="line">14765.0   	&quot;GET&quot; &quot;m:pcl:pad:fircate:73&quot;</div><div class="line">14495.0   	&quot;GET&quot; &quot;catecodeinfo:tag:v2&quot;</div><div class="line">12783.0   	&quot;GET&quot; &quot;p:v:ee:93842379,2&quot;</div><div class="line">11970.25  	&quot;GET&quot; &quot;m:pcl:pad:fircate:73&quot;</div></pre></td></tr></table></figure>
<ul>
<li>commands比例和top keys需要重点排查</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Top Commands</div><div class="line">========================================</div><div class="line">GET      	29435	(89.00%)</div><div class="line"></div><div class="line">Top Keys</div><div class="line">========================================</div><div class="line">m:pcl:pad:fircate:73  	8159	(24.67%)</div><div class="line">catecodeinfo:tag:v2   	1698	(5.13%)</div><div class="line">card:56:92655095,2    	1007	(3.04%)</div><div class="line">card:56:92400031,2    	879 	(2.66%)</div><div class="line">pcl:pad:seccate:60    	578 	(1.75%)</div><div class="line">pcl:pad:seccate:82    	541 	(1.64%)</div><div class="line">p:v:ee:92469530,2     	518 	(1.57%)</div><div class="line">p:s:sort:20171025:22  	426 	(1.29%)</div></pre></td></tr></table></figure>
<ul>
<li>get命令top20</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat 78.41:6382.log | grep GET | awk &apos;&#123;print $5&#125;&apos;  | sort | uniq -c | sort -rn | head -20</div></pre></td></tr></table></figure>
<ul>
<li>debug object查看key值大小</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">*.*.78.41:6382&gt; DEBUG OBJECT catecodeinfo:tag:v2</div><div class="line">Value at:0x7fa68584e230 refcount:1 encoding:raw serializedlength:840478 lru:15826073 lru_seconds_idle:549</div></pre></td></tr></table></figure>
<ul>
<li>客户端ip调用情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat 78.41:6382.log | grep GET | awk &apos;&#123;print $3&quot;=&gt;&quot;$5&#125;&apos; | grep &quot;catecodeinfo:tag:v2&quot; | sort | uniq -c | sort -rn | head -20</div></pre></td></tr></table></figure>
<h2 id="案例分析1-流量报警"><a href="#案例分析1-流量报警" class="headerlink" title="案例分析1:流量报警"></a>案例分析1:流量报警</h2><h3 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h3><ul>
<li><strong>redis报警信息</strong></li>
</ul>
<p><img src="http://i3.itc.cn/20171026/aac_a468f656_656f_f25f_0ff6_7493b7f9956d_1.png" alt=""></p>
<ul>
<li><strong>info stat快照</strong>(*.78.41 <code>redis实例流量报警快照</code>)</li>
</ul>
<p><img src="http://i1.itc.cn/20171026/aac_a468f656_656f_f25f_0ff6_7493b7f9956d_2.png" alt=""></p>
<p>当前ops：1637 当前网络输出流量:67.4M (千兆网卡流量120MB/s)</p>
<ul>
<li><strong>info stat快照</strong>(*.78.41 <code>redis正常时间实例流量快照</code>)</li>
</ul>
<p><img src="http://i1.itc.cn/20171026/aac_a468f656_656f_f25f_0ff6_7493b7f9956d_3.png" alt=""></p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ul>
<li>1.快照分析 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1.通过分析正常/流量报警快照，redis实例的基础统计信息 ops/instantaneous_output_kbps</div><div class="line">2.流量高的时候也可以对比下其他master节点的ops/instantaneous_output_kbps</div><div class="line">3.正常时候ops更高，但输出流量更小。ops低的时候流量高反而流量大，但并没有产生慢查询(&gt;10ms请求)</div><div class="line">4.基本确定有大对象访问</div></pre></td></tr></table></figure>
<ul>
<li>2.执行minitor导出文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1.上redis服务器执行monitor(报警期间)最近一分钟/最近10000执行命令分析。</div><div class="line">redis-cli -p 6382 -a *** monitor | head -n 100000 &gt; 78.41:6382.log</div></pre></td></tr></table></figure>
<ul>
<li>3.分析当前command操作占比以及top20情况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">get调用占比较高</div><div class="line">Top Commands</div><div class="line">========================================</div><div class="line">GET      	29435	(89.00%)</div><div class="line">SETEX    	3411 	(10.31%)</div><div class="line">TTL      	217  	(0.66%)</div><div class="line">HGETALL  	8    	(0.02%)</div><div class="line"></div><div class="line">localhos:log chenshi$ cat 78.41:6382.log | grep GET | awk &apos;&#123;print $5&#125;&apos;  | sort | uniq -c | sort -rn | head -20</div><div class="line">8159 &quot;m:pcl:pad:fircate:73&quot;</div><div class="line">1698 &quot;catecodeinfo:tag:v2&quot;</div><div class="line">1007 &quot;card:56:92655095,2&quot;</div><div class="line"> 879 &quot;card:56:92400031,2&quot;</div><div class="line"> 578 &quot;pcl:pad:seccate:60&quot;</div><div class="line"> 541 &quot;pcl:pad:seccate:82&quot;</div><div class="line"> 518 &quot;p:v:ee:92469530,2&quot;</div><div class="line"> 375 &quot;p:v:ee:92760970,2&quot;</div><div class="line"> 264 &quot;p:v:ee:92414925,2&quot;</div><div class="line"> 264 &quot;card:56:92785886,2&quot;</div><div class="line"> 213 &quot;p:s:sort:20171025:22&quot;</div><div class="line"> 163 &quot;pcl:pad:user:306132492&quot;</div><div class="line"> 161 &quot;p:v:ee:92200421,2&quot;</div><div class="line"> 149 &quot;pcl:pad:topic:12540&quot;</div><div class="line"> 149 &quot;pcl:pad:topic:12020&quot;</div><div class="line"> 149 &quot;m:pcl:pad:topic:12540&quot;</div><div class="line"> 134 &quot;pclcates:56:10080:1&quot;</div><div class="line"> 132 &quot;pcl:pad:seccate:11531&quot;</div><div class="line"> 120 &quot;pcl:pad:topic:10228&quot;</div><div class="line"> 120 &quot;m:pcl:pad:topic:10228&quot;</div><div class="line">``` </div><div class="line"> </div><div class="line">- 4.key产生流量分析,找出大对象</div></pre></td></tr></table></figure>
<p>扫描结果如下：<br>card:56:92785886,2: 264(次)<em>106(字节) =27 kb<br>p:v:ee:92469530,2: 518(次)</em>33(字节) =17 kb<br>p:v:ee:92414925,2: 264(次)<em>34(字节) =8 kb<br>card:56:92655095,2: 1007(次)</em>106(字节) =106 kb<br>card:56:92400031,2: 879(次)<em>106(字节) =93 kb<br>p:v:ee:92760970,2: 375(次)</em>32(字节) =12 kb<br>pclcates:56:10080:1: 134(次)<em>629(字节) =84 kb<br>catecodeinfo:tag:v2: 1698(次)</em>840478(字节) =1427131 kb<br>p:v:ee:92200421,2: 161(次)<em>33(字节) =5 kb<br>p:s:sort:20171025:22: 213(次)</em>16(字节) =3 kb</p>
<p><em>.</em>.78.41:6382&gt; DEBUG OBJECT catecodeinfo:tag:v2<br>Value at:0x7fa5be68c0a0 refcount:1 encoding:raw serializedlength:840844 lru:15816789 lru_seconds_idle:165<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- 5.分析大对象key所有客户端ip执行GET调用情况</div></pre></td></tr></table></figure></p>
<p>localhos:log chenshi$ cat 78.41:6382.log | grep GET | awk ‘{print $3”=&gt;”$5}’ | grep “catecodeinfo:tag:v2” | sort | uniq -c | sort -rn | head -20<br> 420 10.23.194.5:37363]=&gt;”catecodeinfo:tag:v2”<br> 377 10.23.194.6:41135]=&gt;”catecodeinfo:tag:v2”<br> 132 192.168.42.26:35184]=&gt;”catecodeinfo:tag:v2”<br>  64 10.23.194.2:37984]=&gt;”catecodeinfo:tag:v2”<br>  60 10.23.194.6:33715]=&gt;”catecodeinfo:tag:v2”<br>  56 10.23.194.3:48388]=&gt;”catecodeinfo:tag:v2”<br>  54 192.168.42.30:42056]=&gt;”catecodeinfo:tag:v2”<br>  54 10.23.194.2:52091]=&gt;”catecodeinfo:tag:v2”<br>  50 10.23.194.4:37498]=&gt;”catecodeinfo:tag:v2”<br>  46 10.23.194.5:59113]=&gt;”catecodeinfo:tag:v2”<br>  42 192.168.42.23:57718]=&gt;”catecodeinfo:tag:v2”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">## 案例分析1:OPS报警</div><div class="line"></div><div class="line">### 现象</div><div class="line"></div><div class="line">![](http://i3.itc.cn/20171109/aac_f0c5e218_4428_a7d2_8517_1f997b6246ca_1.png)</div><div class="line"></div><div class="line">检查应用报警节点和其他节点</div><div class="line">![](http://i3.itc.cn/20171109/aac_ea19aacd_829b_8723_3eba_7276b59af8aa_2.jpg)</div><div class="line"></div><div class="line">cachecloud调用量情况：(调用量峰值qpm：1700w/min)</div><div class="line">![](http://i3.itc.cn/20171109/aac_3b5ea243_d14c_7b45_1491_3d508ffb8d06_1.png)</div><div class="line">![](http://i3.itc.cn/20171109/aac_ea19aacd_829b_8723_3eba_7276b59af8aa_1.jpg)</div><div class="line"></div><div class="line"></div><div class="line">### 分析</div><div class="line"></div><div class="line">由于10.10.53.184:6393实例 ops总是在5w-6w左右，可能会有热点key</div><div class="line"></div><div class="line">- 执行monitor</div></pre></td></tr></table></figure></p>
<p>执行几秒的monitor命令(服务器上执行)<br>redis-cli -p 6393 monitor &gt; 6393.log.1204<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- 并发量主要分析GET操作</div></pre></td></tr></table></figure></p>
<p>[@zw-53-184 opt]# cat 6393.log.1204 | grep GET | awk ‘{print $5}’ | sort | uniq -c | sort -rn | head -10<br> 153179 “RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>    520 “rrh:a:312813498”<br>    353 “pclcates:56:10080:0”<br>     80 “card:56:92801540,2”<br>     75 “p:v:ee:92399947,2”<br>     39 “card:56:91840554,2”<br>     36 “p:s:version:20171109:122”<br>     33 “CATEGORYCF_V1#4#11682”<br>     25 “m:pcl:pad:fircate:83”<br>     25 “card:56:92845925,2”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> 153179/6s 近似 3w左右调用</div><div class="line"></div><div class="line">- 断定热点key影响,分析客户端调用ip</div><div class="line"></div><div class="line">调用次数 客户端ip  key</div></pre></td></tr></table></figure></p>
<p>[@zw-53-184 opt]# cat 6393.log.1204 | grep GET | awk ‘{print $3”=&gt;”$5}’ | grep ‘RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9’ | sort | uniq -c | sort -rn | head -20<br>   1040 192.168.42.40:11081]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1035 192.168.42.40:11593]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1034 192.168.42.40:11637]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1034 192.168.42.40:11557]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1033 192.168.42.40:11683]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1033 192.168.42.40:11662]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1033 192.168.42.40:11539]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1032 192.168.42.40:11664]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1032 192.168.42.40:11646]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1029 192.168.42.41:57043]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1028 192.168.42.40:11658]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1028 192.168.42.40:11581]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1025 192.168.42.40:11598]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1025 192.168.42.40:11425]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1023 192.168.42.41:57297]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1023 192.168.42.40:11663]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1023 192.168.42.40:11537]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1022 192.168.42.40:11645]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1021 192.168.42.40:11544]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>   1013 192.168.42.40:11599]=&gt;”RG#\xe8\x88\x9e\xe5\x87\xba\xe7\xb2\xbe\xe5\xbd\xa9”<br>```</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/25/9.6)redis运维列表/" itemprop="url">
                  redis原理和cachecloud运维目录
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-25T16:37:35+08:00" content="2017-10-25">
              2017-10-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/cachecloud/" itemprop="url" rel="index">
                    <span itemprop="name">cachecloud</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="redis原理"><a href="#redis原理" class="headerlink" title="redis原理"></a>redis原理</h1><h1 id="cachecloud运维"><a href="#cachecloud运维" class="headerlink" title="cachecloud运维"></a>cachecloud运维</h1>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/24/9.6) jedispool连接池总结/" itemprop="url">
                  jedispool连接池总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-24T10:33:00+08:00" content="2017-10-24">
              2017-10-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/连接池/" itemprop="url" rel="index">
                    <span itemprop="name">连接池</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>apache对象池:<a href="http://commons.apache.org/proper/commons-pool/" target="_blank" rel="external">对象池</a></p>
<h2 id="对象池"><a href="#对象池" class="headerlink" title="对象池"></a>对象池</h2><p>我们常用的池子像 数据库连接池、jedis连接池、线程池等，查看源码会发现这些池管理类都是继承于GenericObjectPool<t>，所以我们需要了解下GenericObjectPool的工作机制。</t></p>
<p>对象池的类图:<br><img src="http://img.blog.csdn.net/20160501212832585?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="类图"></p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/10/24/9.6) jedispool连接池总结/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/24/9.8)redis多路复用技术/" itemprop="url">
                  redis  I/O 多路复用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-24T10:33:00+08:00" content="2017-10-24">
              2017-10-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/多路复用/" itemprop="url" rel="index">
                    <span itemprop="name">多路复用</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>参考：<br><a href="https://zhuanlan.zhihu.com/p/24252862?refer=belief" target="_blank" rel="external">Redis 和 I/O 多路复用</a><br><a href="https://www.zhihu.com/question/28594409" target="_blank" rel="external">多路复用-知乎</a><br><a href="https://segmentfault.com/a/1190000003063859#articleHeader6" target="_blank" rel="external">liunx的I/O模型</a><br><a href="https://github.com/antirez/redis" target="_blank" rel="external">redis官方wiki</a></p>
</blockquote>
<h2 id="为什么-Redis-中要使用-I-O-多路复用这种技术呢？"><a href="#为什么-Redis-中要使用-I-O-多路复用这种技术呢？" class="headerlink" title="为什么 Redis 中要使用 I/O 多路复用这种技术呢？"></a>为什么 Redis 中要使用 I/O 多路复用这种技术呢？</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">I/O多路复用(又被称为“事件驱动”):即是多个网路连接共享同一个线程。</div><div class="line">当你的某个socket可读或者可写的时候，它可以给你一个通知。操作系统的这个功能通过select/poll</div><div class="line">/epoll/kqueue之类的系统调用函数来使用，这些函数都可以同时监视多个描述符的读写就绪状况，这</div><div class="line">样，多个描述符的I/O操作都能在一个线程内并发交替地顺序完成，这就叫I/O多路复用，这里的“复用”指</div><div class="line">的是复用同一个线程。</div><div class="line">Linux环境下，Redis数据库服务器大部分时间以单进程单线程模式运行(执行持久化BGSAVE任务时会开</div><div class="line">启子进程)，即非阻塞的socket文件描述符号加上监控这些描述符的I/O多路复用机制（在Linux下可以使用select/poll/epoll系统调用命令）,使用reactor模式时间监听模式：文件事件和时间事件。</div><div class="line">文件事件指的是socket文件描述符的读写就绪情况，时间事件分为一次性定时器和周期性定时器。</div></pre></td></tr></table></figure>
<p>I/O 多路复用模块：</p>
<p><img src="https://pic4.zhimg.com/v2-93c716f502a769042cd26f357972b687_b.jpgs" alt=""></p>
<p>mutliplex io好处:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1.线程是有内存开销的，1个线程可能需要512K（或2M）存放栈，那么1000个线程就要512M（或2G）</div><div class="line">内存。redis单线程节省大量开销。</div><div class="line">2.线程的切换，或者说上下文切换是有CPU开销的，当大量时间花在上下文切换的时候，分配给真正的操</div><div class="line">作的CPU就要少很多。redis单线程避免了线程切换开销。(aof重写,rdb fork子进程)</div><div class="line">3.基于事件模型，数据处理的状态 通过selector队列器 监控，一旦状态到达就通知处理。</div></pre></td></tr></table></figure></p>
<p><strong>redis处理模型:</strong></p>
<ul>
<li>建立socket连接(单线程处理多个socket连接，默认maxclient:10000)</li>
<li>执行redis命令(数据读取过程,事件触发读/写)</li>
</ul>
<p><strong>redis epoll模式：</strong></p>
<image src="http://i3.itc.cn/20171030/aac_f2bfb40f_f3fb_88bf_94f7_2540ee2b8361_1.png" height="300" width="400">

<h2 id="IO方式"><a href="#IO方式" class="headerlink" title="IO方式"></a>IO方式</h2><h3 id="Blocking-IO"><a href="#Blocking-IO" class="headerlink" title="Blocking IO"></a>Blocking IO</h3><p><img src="https://pic2.zhimg.com/v2-ecdd648dff385412db4aea1014ee1d51_b.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">当使用 read 或者 write 对某一个文件描述符（File Descriptor 以下简称 FD)进行读写时，如果</div><div class="line">当前 FD 不可读或不可写，整个 Redis 服务就不会对其它的操作作出响应，导致整个服务不可用。</div><div class="line">redis主线程被阻塞。</div></pre></td></tr></table></figure>
<h3 id="多路复用-IO"><a href="#多路复用-IO" class="headerlink" title="多路复用 IO"></a>多路复用 IO</h3><p>阻塞式的 I/O 模型并不能满足这里的需求，我们需要一种效率更高的 I/O 模型来支撑 Redis 的多个客户（redis-cli），这里涉及的就是 I/O 多路复用模型了。</p>
<p><img src="https://pic3.zhimg.com/v2-4769dd88e9cf685b052610f36f5e177e_b.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">解释1:在 I/O 多路复用模型中，最重要的函数调用就是 select，该方法的能够同时监控多个文件描述</div><div class="line">符的可读可写情况，当其中的某些文件描述符可读或者可写时，select 方法就会返回可读以及可写的文</div><div class="line">件描述符个数。</div><div class="line"></div><div class="line">解释2:多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和</div><div class="line">poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪</div><div class="line">状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）。</div></pre></td></tr></table></figure>
<h3 id="Reactor-设计模式"><a href="#Reactor-设计模式" class="headerlink" title="Reactor 设计模式"></a>Reactor 设计模式</h3><p>Redis 服务采用 Reactor 的方式来实现文件事件处理器（每一个网络连接其实都对应一个文件描述符）</p>
<p><img src="https://pic3.zhimg.com/v2-4cff43ccb083a587b0e4834acff884fa_b.png" alt=""></p>
<p>事件类型: accept(socket建立连接事件) + read(数据读事件) + write(数据写事件) + close（关闭事件）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">文件事件处理器使用 I/O 多路复用模块同时监听多个 FD，当 accept、read、write 和 close </div><div class="line">文件事件产生时，文件事件处理器就会回调 FD 绑定的事件处理器。</div><div class="line">虽然整个文件事件处理器是在单线程上运行的，但是通过 I/O 多路复用模块的引入，实现了同时对多</div><div class="line">个 FD 读写的监控，提高了网络通信模型的性能，同时也可以保证整个 Redis 服务实现的简单.</div></pre></td></tr></table></figure>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">下面举一个例子，模拟一个tcp服务器处理30个客户socket。</div><div class="line">假设你是一个老师，让30个学生解答一道题目，然后检查学生做的是否正确，你有下面几个选择：</div><div class="line"></div><div class="line">1.第一种选择：按顺序逐个检查，先检查A，然后是B，之后是C、D。。。这中间如果有一个学生卡主，</div><div class="line">全班都会被耽误。这种模式就好比，你用循环挨个处理socket，根本不具有并发能力。</div><div class="line">2.第二种选择：你创建30个分身，每个分身检查一个学生的答案是否正确。 这种类似于为每一个用户创建</div><div class="line">一个进程或者线程处理连接。</div><div class="line">3.第三种选择，你站在讲台上等，谁解答完谁举手。这时C、D举手，表示他们解答问题完毕，你下去依次检查C、D的答案，然后继续回到讲台上等。此时E、A又举手，然后去处理E和A。。。 这种就是IO复用模型，Linux下的select、poll和epoll就是干这个的。将用户socket对应的fd注册进epoll，然后</div><div class="line">epoll帮你监听哪些socket上有消息到达，这样就避免了大量的无用操作。此时的socket应该采用非</div><div class="line">阻塞模式。</div><div class="line"></div><div class="line">这样，整个过程只在调用select、poll、epoll这些调用的时候才会阻塞，收发客户消息是</div><div class="line">不会阻塞的，整个进程或者线程就被充分利用起来，这就是事件驱动，所谓的reactor模式。</div></pre></td></tr></table></figure>
</image>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/22/10.4).netflix-atlas使用/" itemprop="url">
                  altas指标监控平台使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-22T10:11:00+08:00" content="2017-10-22">
              2017-10-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/altas/" itemprop="url" rel="index">
                    <span itemprop="name">altas</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="grafana安装"><a href="#grafana安装" class="headerlink" title="grafana安装"></a>grafana安装</h2><h2 id="altas收集"><a href="#altas收集" class="headerlink" title="altas收集"></a>altas收集</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/21/10.4) netflix-hystrix熔断/" itemprop="url">
                  hystrix使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-21T10:11:00+08:00" content="2017-10-21">
              2017-10-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/hystrix/" itemprop="url" rel="index">
                    <span itemprop="name">hystrix</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="hystrix-dashboard使用"><a href="#hystrix-dashboard使用" class="headerlink" title="hystrix-dashboard使用"></a>hystrix-dashboard使用</h2><h3 id="搭建dashboard"><a href="#搭建dashboard" class="headerlink" title="搭建dashboard"></a>搭建dashboard</h3><ul>
<li>直接启动</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git clone https://github.com/Netflix/Hystrix.git</div><div class="line">$ cd Hystrix/hystrix-dashboard</div><div class="line">$ ../gradlew appRun</div></pre></td></tr></table></figure>
<p><code>dashboard地址:</code><a href="http://localhost:7979/hystrix-dashboard" target="_blank" rel="external">http://localhost:7979/hystrix-dashboard</a></p>
<ul>
<li>后台启动</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">java -jar -DserverPort=8080 -DbindAddress=192.168.1.100 standalone-hystrix-dashboard-&#123;VERSION&#125;-all.jar</div><div class="line"></div><div class="line">serverPort	The port that the server will listen to.   7979</div><div class="line">bindAddress	The address that the server will bind to.  0.0.0.0</div><div class="line">disableCompression	Flag to disable compression support for the metrics stream. enable</div></pre></td></tr></table></figure>
<h3 id="dashboard配置"><a href="#dashboard配置" class="headerlink" title="dashboard配置"></a>dashboard配置</h3><p><code>hystrix-dashboard后台</code>:<a href="http://127.0.0.1:7979/hystrix-dashboard/" target="_blank" rel="external">http://127.0.0.1:7979/hystrix-dashboard/</a></p>
<p><img src="http://i3.itc.cn/20171024/aac_12264e27_e85d_67d4_bc49_5db5c608fa7f_2.png" alt=""></p>
<p><code>客户端数据流</code>:<a href="http://10.7.36.64:7771/hystrix.stream" target="_blank" rel="external">http://10.7.36.64:7771/hystrix.stream</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">data: &#123;&quot;type&quot;:&quot;HystrixCommand&quot;,&quot;name&quot;:&quot;getTime&quot;,&quot;group&quot;:&quot;RestServiceImpl&quot;,&quot;currentTime&quot;:1508827134796,&quot;isCircuitBreakerOpen&quot;:false,&quot;errorPercentage&quot;:0,&quot;errorCount&quot;:0,&quot;requestCount&quot;:0,&quot;rollingCountBadRequests&quot;:0,&quot;rollingCountCollapsedRequests&quot;:0,&quot;rollingCountEmit&quot;:0,&quot;rollingCountExceptionsThrown&quot;:0,&quot;rollingCountFailure&quot;:0,&quot;rollingCountFallbackEmit&quot;:0,&quot;rollingCountFallbackFailure&quot;:0,&quot;rollingCountFallbackMissing&quot;:0,&quot;rollingCountFallbackRejection&quot;:0,&quot;rollingCountFallbackSuccess&quot;:0,&quot;rollingCountResponsesFromCache&quot;:0,&quot;rollingCountSemaphoreRejected&quot;:0,&quot;rollingCountShortCircuited&quot;:0,&quot;rollingCountSuccess&quot;:0,&quot;rollingCountThreadPoolRejected&quot;:0,&quot;rollingCountTimeout&quot;:0,&quot;currentConcurrentExecutionCount&quot;:0,&quot;rollingMaxConcurrentExecutionCount&quot;:0,&quot;latencyExecute_mean&quot;:0,&quot;latencyExecute&quot;:&#123;&quot;0&quot;:0,&quot;25&quot;:0,&quot;50&quot;:0,&quot;75&quot;:1,&quot;90&quot;:1,&quot;95&quot;:1,&quot;99&quot;:1,&quot;99.5&quot;:1,&quot;100&quot;:1&#125;,&quot;latencyTotal_mean&quot;:0,&quot;latencyTotal&quot;:&#123;&quot;0&quot;:0,&quot;25&quot;:0,&quot;50&quot;:0,&quot;75&quot;:1,&quot;90&quot;:1,&quot;95&quot;:1,&quot;99&quot;:1,&quot;99.5&quot;:1,&quot;100&quot;:1&#125;,&quot;propertyValue_circuitBreakerRequestVolumeThreshold&quot;:20,&quot;propertyValue_circuitBreakerSleepWindowInMilliseconds&quot;:5000,&quot;propertyValue_circuitBreakerErrorThresholdPercentage&quot;:50,&quot;propertyValue_circuitBreakerForceOpen&quot;:false,&quot;propertyValue_circuitBreakerForceClosed&quot;:false,&quot;propertyValue_circuitBreakerEnabled&quot;:true,&quot;propertyValue_executionIsolationStrategy&quot;:&quot;THREAD&quot;,&quot;propertyValue_executionIsolationThreadTimeoutInMilliseconds&quot;:1000,&quot;propertyValue_executionTimeoutInMilliseconds&quot;:1000,&quot;propertyValue_executionIsolationThreadInterruptOnTimeout&quot;:true,&quot;propertyValue_executionIsolationThreadPoolKeyOverride&quot;:null,&quot;propertyValue_executionIsolationSemaphoreMaxConcurrentRequests&quot;:10,&quot;propertyValue_fallbackIsolationSemaphoreMaxConcurrentRequests&quot;:10,&quot;propertyValue_metricsRollingStatisticalWindowInMilliseconds&quot;:10000,&quot;propertyValue_requestCacheEnabled&quot;:true,&quot;propertyValue_requestLogEnabled&quot;:true,&quot;reportingHosts&quot;:1,&quot;threadPool&quot;:&quot;RestServiceImpl&quot;&#125;</div><div class="line">data: &#123;&quot;type&quot;:&quot;HystrixThreadPool&quot;,&quot;name&quot;:&quot;RestServiceImpl&quot;,&quot;currentTime&quot;:1508827134796,&quot;currentActiveCount&quot;:0,&quot;currentCompletedTaskCount&quot;:5,&quot;currentCorePoolSize&quot;:10,&quot;currentLargestPoolSize&quot;:5,&quot;currentMaximumPoolSize&quot;:10,&quot;currentPoolSize&quot;:5,&quot;currentQueueSize&quot;:0,&quot;currentTaskCount&quot;:5,&quot;rollingCountThreadsExecuted&quot;:0,&quot;rollingMaxActiveThreads&quot;:0,&quot;rollingCountCommandRejections&quot;:0,&quot;propertyValue_queueSizeRejectionThreshold&quot;:5,&quot;propertyValue_metricsRollingStatisticalWindowInMilliseconds&quot;:10000,&quot;reportingHosts&quot;:1&#125;</div><div class="line">....</div></pre></td></tr></table></figure>
<p><code>开启monitor</code></p>
<p><img src="http://i2.itc.cn/20171024/aac_12264e27_e85d_67d4_bc49_5db5c608fa7f_1.png" alt=""></p>
<h2 id="hystrix客户端配置"><a href="#hystrix客户端配置" class="headerlink" title="hystrix客户端配置"></a>hystrix客户端配置</h2><ul>
<li>pom依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> &lt;!-- hystrix --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-cloud-starter-hystrix&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<ul>
<li>启动类注解 @EnableCircuitBreaker</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="meta">@EnableDiscoveryClient</span></div><div class="line"><span class="meta">@EnableFeignClients</span></div><div class="line"><span class="meta">@EnableCircuitBreaker</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> SpringApplication().run(ClientApplication.class,args);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Bean</span></div><div class="line">    <span class="meta">@LoadBalanced</span></div><div class="line">    <span class="function">RestTemplate <span class="title">restTemplate</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>service配置hystrix降级 @HystrixCommand</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestServiceImpl</span> <span class="keyword">implements</span> <span class="title">RestService</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    RestTemplate restTemplate;</div><div class="line"></div><div class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"getTimeFallback"</span>)</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> restTemplate.getForEntity(<span class="string">"http://test.server1/get"</span>,String.class).getBody();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTimeFallback</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"fallback return : 2017-10-24 00:00:00"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>结果调试</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://10.7.36.64:7771/c3/get</div><div class="line"></div><div class="line">正常返回:s1client execute get 1,time=1508829619207</div><div class="line">降级返回:fallback return : 2017-10-24 00:00:00</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/21/10.3) springcloud-rpc使用/" itemprop="url">
                  springcloud rpc使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-21T10:11:00+08:00" content="2017-10-21">
              2017-10-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ribbon/" itemprop="url" rel="index">
                    <span itemprop="name">ribbon</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ribbon/fegin/" itemprop="url" rel="index">
                    <span itemprop="name">fegin</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ribbon/fegin/resttemplate/" itemprop="url" rel="index">
                    <span itemprop="name">resttemplate</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><p>ribbon是基于客户端的一个负载均衡器。</p>
<p>当Ribbon与Eureka联合使用时，ribbonServerList会被DiscoveryEnabledNIWSServerList重写，扩展成从Eureka注册中心中获取服务端列表。同时它也会用NIWSDiscoveryPing来取代IPing，它将职责委托给Eureka来确定服务端是否已经启动。</p>
<h2 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h2><h2 id="feign"><a href="#feign" class="headerlink" title="feign"></a>feign</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/metor.ico"
               alt="Pedestrian" />
          <p class="site-author-name" itemprop="name">Pedestrian</p>
          <p class="site-description motion-element" itemprop="description">study for goal</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">27</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yanan0628" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://carlosfu.github.io/" target="_blank" title="fudada">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  fudada
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://jolinzhangg.github.io/" target="_blank" title="xiaodada">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  xiaodada
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pedestrian</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
