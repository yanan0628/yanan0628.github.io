<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="study for goal">
<meta property="og:type" content="website">
<meta property="og:title" content="Meteor">
<meta property="og:url" content="/page/3/index.html">
<meta property="og:site_name" content="Meteor">
<meta property="og:description" content="study for goal">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Meteor">
<meta name="twitter:description" content="study for goal">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Meteor </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Meteor</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/10/20/10.2) springcloud-eureka使用/" itemprop="url">
                  spring eureka使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-10-20T10:11:00+08:00" content="2017-10-20">
              2017-10-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/eureka/" itemprop="url" rel="index">
                    <span itemprop="name">eureka</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="euraka-server"><a href="#euraka-server" class="headerlink" title="euraka server"></a>euraka server</h2><h3 id="构建erueka注册中心"><a href="#构建erueka注册中心" class="headerlink" title="构建erueka注册中心"></a>构建erueka注册中心</h3><ul>
<li>1.pom依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<ul>
<li>2.eureka服务启动类 ServerApplication</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">package com.sohu.index.springcloud.learn;</div><div class="line"></div><div class="line">import org.springframework.boot.SpringApplication;</div><div class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line">import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by chenshi on 2017/10/20.</div><div class="line"> */</div><div class="line">@SpringBootApplication</div><div class="line">@EnableEurekaServer</div><div class="line">public class ServerApplication &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        new SpringApplication().run(ServerApplication.class,args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>3.application.yml配置文件</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">9191</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:$&#123;server.port&#125;/eureka/</span></div></pre></td></tr></table></figure>
<ul>
<li>4.启动服务</li>
</ul>
<p>eureka地址:<a href="http://127.0.0.1:9191/" target="_blank" rel="external">http://127.0.0.1:9191/</a>    </p>
<h3 id="eureka注册中心权限"><a href="#eureka注册中心权限" class="headerlink" title="eureka注册中心权限"></a>eureka注册中心权限</h3><ul>
<li>1.pom依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<ul>
<li>2.全局配置bootstrap.yml</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">security:</div><div class="line">    basic:</div><div class="line">      enabled: true</div><div class="line">    user:</div><div class="line">      name: admin</div><div class="line">      password: 123</div></pre></td></tr></table></figure>
<h2 id="eureka-client"><a href="#eureka-client" class="headerlink" title="eureka client"></a>eureka client</h2><h3 id="客户端服务注册"><a href="#客户端服务注册" class="headerlink" title="客户端服务注册"></a>客户端服务注册</h3><ul>
<li>1.pom依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;!-- eureka client --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<ul>
<li>2.启动类ClientApplication</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">package com.sohu.index.springcloud.learn;</div><div class="line"></div><div class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line">import org.springframework.boot.builder.SpringApplicationBuilder;</div><div class="line">import org.springframework.cloud.client.discovery.EnableDiscoveryClient;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by chenshi on 2017/8/9.</div><div class="line"> */</div><div class="line">@SpringBootApplication</div><div class="line">@EnableDiscoveryClient</div><div class="line">public class ClientAppllication &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        new SpringApplicationBuilder(ClientAppllication.class).web(true).run(args);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>3.application.yml配置</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="attr">spring:</span></div><div class="line"><span class="attr">  application:</span></div><div class="line"><span class="attr">    name:</span> <span class="string">test.client1</span></div><div class="line"><span class="attr">server:</span></div><div class="line"><span class="attr">  port:</span> <span class="number">8881</span></div><div class="line"><span class="attr">eureka:</span></div><div class="line"><span class="attr">  client:</span></div><div class="line"><span class="attr">    service-url:</span></div><div class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://127.0.0.1:9191/eureka/</span></div></pre></td></tr></table></figure>
<ul>
<li><p>4.web服务相关配置</p>
<ul>
<li><p>pom依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;!-- web --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;!-- actuator端点 info env  --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<pre><code>- 相关端点

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">系统环境:http://10.7.36.64:8881/env</div><div class="line">自动配置:http://10.7.36.64:8881/autoconfig</div></pre></td></tr></table></figure>
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/09/18/10.1).spring-boot使用/" itemprop="url">
                  spring boot使用和接入
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-09-18T16:37:35+08:00" content="2017-09-18">
              2017-09-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/springboot/" itemprop="url" rel="index">
                    <span itemprop="name">springboot</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="spring-boot使用和接入"><a href="#spring-boot使用和接入" class="headerlink" title="spring boot使用和接入"></a>spring boot使用和接入</h1><p>参考：<a href="https://qbgbook.gitbooks.io/spring-boot-reference-guide-zh/content/III.%20Using%20Spring%20Boot/" target="_blank" rel="external">spring boot中文wiki</a><br><a href="http://www.cnblogs.com/renhui/p/5910300.html" target="_blank" rel="external">annotation</a></p>
<h2 id="spring-boot优势"><a href="#spring-boot优势" class="headerlink" title="spring boot优势"></a>spring boot优势</h2><ol>
<li>boot项目把容器打到jar包，可以通过java -jar *.jar启动一个web/</li>
<li>可将服务配置成系统级别启动/停止，只依赖操作系统和jdk</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo ln -s $&#123;path&#125;/*.jar /etc/init.d/$&#123;服务名&#125;</div><div class="line">chmod 700 /etc/init.d/$&#123;服务名&#125;</div><div class="line">echo &quot;renew /etc/init.d/$&#123;服务名&#125;&quot;</div></pre></td></tr></table></figure>
<ol>
<li>遵循boot规范      <ul>
<li>spring.factories默认配置文件</li>
<li>jar依赖规范</li>
</ul>
</li>
</ol>
<h2 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h2><h3 id="启动解析"><a href="#启动解析" class="headerlink" title="启动解析"></a>启动解析</h3><ul>
<li>SpringFactoriesLoader抽象类装载spring.factories</li>
</ul>
<p>每个spring-boot报META-INF下都会依赖spring.factory<br>    autoconfig检测：<a href="http://127.0.0.1:8888/autoconfig" target="_blank" rel="external">http://127.0.0.1:8888/autoconfig</a></p>
<pre><code>#Failure analyzers ()
org.springframework.boot.diagnostics.FailureAnalyzer
</code></pre><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</div><div class="line">        String factoryClassName = factoryClass.getName();</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Enumeration ex = classLoader != <span class="keyword">null</span>?classLoader.getResources(<span class="string">"META-INF/spring.factories"</span>):ClassLoader.getSystemResources(<span class="string">"META-INF/spring.factories"</span>);</div><div class="line">            ArrayList result = <span class="keyword">new</span> ArrayList();</div><div class="line"></div><div class="line">            <span class="keyword">while</span>(ex.hasMoreElements()) &#123;</div><div class="line">                URL url = (URL)ex.nextElement();</div><div class="line">                Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(url));</div><div class="line">                String factoryClassNames = properties.getProperty(factoryClassName);</div><div class="line">                result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException var8) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load ["</span> + factoryClass.getName() + <span class="string">"] factories from location ["</span> + <span class="string">"META-INF/spring.factories"</span> + <span class="string">"]"</span>, var8);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>初始化 applicationContext IOC容器</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</div><div class="line">	...</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">            DefaultApplicationArguments ex = <span class="keyword">new</span> DefaultApplicationArguments(args);</div><div class="line">            ConfigurableEnvironment environment = <span class="keyword">this</span>.prepareEnvironment(listeners, ex);</div><div class="line">            Banner printedBanner = <span class="keyword">this</span>.printBanner(environment);</div><div class="line">            context = <span class="keyword">this</span>.createApplicationContext();<span class="comment">//初始化 context</span></div><div class="line">            <span class="keyword">new</span> FailureAnalyzers(context);</div><div class="line">            <span class="keyword">this</span>.prepareContext(context, environment, listeners, ex, printedBanner);</div><div class="line">            <span class="keyword">this</span>.refreshContext(context);</div><div class="line">            <span class="keyword">this</span>.afterRefresh(context, ex);</div><div class="line">            listeners.finished(context, (Throwable)<span class="keyword">null</span>);</div><div class="line">            stopWatch.stop();</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">this</span>.logStartupInfo) &#123;</div><div class="line">                (<span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)).logStarted(<span class="keyword">this</span>.getApplicationLog(), stopWatch);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> context;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</div><div class="line">            <span class="keyword">this</span>.handleRunFailure(context, listeners, (FailureAnalyzers)analyzers, var9);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var9);</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="外部化配置"><a href="#外部化配置" class="headerlink" title="外部化配置"></a>外部化配置</h3><p><a href="http://ip:port/env" target="_blank" rel="external">http://ip:port/env</a> （加载优先级 从上到下）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Spring Boot设计了一个非常特别的PropertySource顺序，以允许对属性值进行合理的覆盖，属性会以如下的顺序进行设值：</div><div class="line">home目录下的devtools全局设置属性（~/.spring-boot-devtools.properties，如果devtools激活）。</div><div class="line">测试用例上的@TestPropertySource注解。</div><div class="line">测试用例上的@SpringBootTest#properties注解。</div><div class="line">命令行参数</div><div class="line">来自SPRING_APPLICATION_JSON的属性（环境变量或系统属性中内嵌的内联JSON）。</div><div class="line">ServletConfig初始化参数。</div><div class="line">ServletContext初始化参数。</div><div class="line">来自于java:comp/env的JNDI属性。</div><div class="line">Java系统属性（System.getProperties()）。</div><div class="line">操作系统环境变量。</div><div class="line">RandomValuePropertySource，只包含random.*中的属性。</div><div class="line">没有打进jar包的Profile-specific应用属性（application-&#123;profile&#125;.properties和YAML变量）。</div><div class="line">打进jar包中的Profile-specific应用属性（application-&#123;profile&#125;.properties和YAML变量）。</div><div class="line">没有打进jar包的应用配置（application.properties和YAML变量）。</div><div class="line">打进jar包中的应用配置（application.properties和YAML变量）。</div><div class="line">@Configuration类上的@PropertySource注解。</div><div class="line">默认属性（使用SpringApplication.setDefaultProperties指定）。</div></pre></td></tr></table></figure>
<h3 id="注解配置"><a href="#注解配置" class="headerlink" title="注解配置"></a>注解配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@ComponentScan：注解自动收集所有Spring组件，包括@Configuration类 </div><div class="line">@Configuration： 作为主要配置源</div><div class="line">@ImportResource：注解加载XML配置文件</div><div class="line">@EnableAutoConfiguration: 从classpath中搜寻所有的META-INF/spring.factories配置文件</div><div class="line">	借助@Import(&#123;EnableAutoConfigurationImportSelector.class&#125;)的帮助，</div><div class="line">	将所有符合自动配置条件的bean定义加载到IoC</div><div class="line">@SpringBootApplication注解等价于	</div><div class="line">    @Configuration+@EnableAutoConfiguration+@ComponentScan</div></pre></td></tr></table></figure>
<h3 id="实现自定义自动配置"><a href="#实现自定义自动配置" class="headerlink" title="实现自定义自动配置"></a>实现自定义自动配置</h3><ul>
<li>jvm参数监控</li>
<li>tomcat线程池监控</li>
</ul>
<h2 id="spring-boot模块"><a href="#spring-boot模块" class="headerlink" title="spring boot模块"></a>spring boot模块</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">spring-boot-starter-web	用于使用Spring MVC构建web应用，包括RESTful。Tomcat是默认的内嵌容器</div><div class="line">spring-boot-starter-jdbc	对JDBC的支持（使用Tomcat JDBC连接池）</div><div class="line">spring-boot-starter-aop	用于使用Spring AOP和AspectJ实现面向切面编程</div><div class="line">spring-boot-starter-test	用于测试Spring Boot应用，支持常用测试类库，包括JUnit, Hamcrest和Mockito</div><div class="line">spring-boot-starter-actuator	用于使用Spring Boot的Actuator，它提供了production ready功能来帮助你监控和管理应用程序</div><div class="line"></div><div class="line">所有模块:https://qbgbook.gitbooks.io/spring-boot-reference-guide-zh/content/III.%20Using%20Spring%20Boot/13.5.%20Starters.html</div></pre></td></tr></table></figure>
<h2 id="如何接入"><a href="#如何接入" class="headerlink" title="如何接入?"></a>如何接入?</h2><blockquote>
<p>1.pom parent依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">只需在该依赖上指定Spring Boot版本，如果导入其他的starters，放心的省略版本号好了</div><div class="line"><span class="comment">&lt;!-- Inherit defaults from Spring Boot --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1.BUILD-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>3.运行</p>
</blockquote>
<p>直接运行：mvn spring-boot:run<br>打包运行: mvn package  |  java -jar *.jar</p>
<blockquote>
<p>4.打包规范</p>
</blockquote>
<p><code>包命名规范</code>: </p>
<pre><code>${package-name}-online.jar  
${package-name}-online.war
${package-name}-online.conf
</code></pre><p>相关配置*.conf配置文件</p>
<pre><code>jvm配置/日志目录/java_Home
</code></pre><p><img src="http://i2.itc.cn/20171019/aac_44ff2159_b675_2098_94c8_e070df0b204b_1.png" alt=""></p>
<h2 id="升级接入遇到问题"><a href="#升级接入遇到问题" class="headerlink" title="升级接入遇到问题?"></a>升级接入遇到问题?</h2><ul>
<li><p>1.web.xml配置空,servlet、filter、inteceptor改用注解方式，自动扫描需用到注解</p>
<p>  @ServletComponentScan</p>
</li>
<li><p>2.依赖jsp的项目 pom依赖?</p>
</li>
<li><p>3.启动类Application需要在根目录，这样就可以自动扫描子目录的package</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">将应用的main类放到其他类所在包的顶层(root package),并将@EnableAutoConfiguration注解到你的main类上，这样就隐式地定义了一个基础的包搜索路径（search package）以搜索某些特定的注解实体（比如@Service，@Component等）</div></pre></td></tr></table></figure>
</li>
<li><p>4.打包方式 依赖spring-boot-maven-plugin 需要指定启动类，打完jar war包是一个二进制文件 </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">	more *.jar | *.war 查看当前执行文件</div><div class="line">	</div><div class="line">	#!/bin/bash</div><div class="line">	#</div><div class="line">	#    .   ____          _            __ _ _</div><div class="line">	#   /\\ / ___&apos;_ __ _ _(_)_ __  __ _ \ \ \ \</div><div class="line">	#  ( ( )\___ | &apos;_ | &apos;_| | &apos;_ \/ _` | \ \ \ \</div><div class="line">	#   \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</div><div class="line">	#    &apos;  |____| .__|_| |_|_| |_\__, | / / / /</div><div class="line">	#   =========|_|==============|___/=/_/_/_/</div><div class="line">	#   :: Spring Boot Startup Script ::</div><div class="line">	#</div><div class="line">		</div><div class="line">	### BEGIN INIT INFO</div><div class="line">	# Provides:          cachecloud-web</div><div class="line">	# Required-Start:    $remote_fs $syslog $network</div><div class="line">	# Required-Stop:     $remote_fs $syslog $network</div><div class="line">	# Default-Start:     2 3 4 5</div><div class="line">	# Default-Stop:      0 1 6</div><div class="line">	# Short-Description: cachecloud-web</div><div class="line">	# Description:       cachecloud-web</div><div class="line">	# chkconfig:         2345 99 01</div><div class="line">	### END INIT INFO</div><div class="line">	</div><div class="line">	[[ -n &quot;$DEBUG&quot; ]] &amp;&amp; set -x</div><div class="line">	</div><div class="line">	# Initialize variables that cannot be provided by a .conf file</div><div class="line">	WORKING_DIR=&quot;$(pwd)&quot;</div><div class="line">	# shellcheck disable=SC2153</div><div class="line">	[[ -n &quot;$JARFILE&quot; ]] &amp;&amp; jarfile=&quot;$JARFILE&quot;</div><div class="line">	[[ -n &quot;$APP_NAME&quot; ]] &amp;&amp; identity=&quot;$APP_NAME&quot;</div><div class="line">	</div><div class="line">	# Follow symlinks to find the real jar and detect init.d script</div><div class="line">	cd &quot;$(dirname &quot;$0&quot;)&quot; || exit 1</div><div class="line">	[[ -z &quot;$jarfile&quot; ]] &amp;&amp; jarfile=$(pwd)/$(basename &quot;$0&quot;)</div><div class="line">	while [[ -L &quot;$jarfile&quot; ]]; do</div><div class="line">	  [[ &quot;$jarfile&quot; =~ init\.d ]] &amp;&amp; init_script=$(basename &quot;$jarfile&quot;)</div><div class="line">	  jarfile=$(readlink &quot;$jarfile&quot;)</div><div class="line">	  cd &quot;$(dirname &quot;$jarfile&quot;)&quot; || exit 1</div><div class="line">	  jarfile=$(pwd)/$(basename &quot;$jarfile&quot;)</div><div class="line">	done</div><div class="line">	jarfolder=&quot;$(dirname &quot;$jarfile&quot;)&quot;</div><div class="line">	cd &quot;$WORKING_DIR&quot; || exit 1</div><div class="line">	# Source any config file</div><div class="line">	configfile=&quot;$(basename &quot;$&#123;jarfile%.*&#125;.conf&quot;)&quot;</div><div class="line">	# shellcheck source=/dev/null</div><div class="line">	[[ -r &quot;$&#123;jarfolder&#125;/$&#123;configfile&#125;&quot; ]] &amp;&amp; source &quot;$&#123;jarfolder&#125;/$&#123;configfile&#125;&quot;</div><div class="line">	</div><div class="line">	# Initialize PID/LOG locations if they weren&apos;t provided by the config file</div><div class="line">	[[ -z &quot;$PID_FOLDER&quot; ]] &amp;&amp; PID_FOLDER=&quot;/var/run&quot;</div><div class="line">	[[ -z &quot;$LOG_FOLDER&quot; ]] &amp;&amp; LOG_FOLDER=&quot;/var/log&quot;</div><div class="line">	! [[ -x &quot;$PID_FOLDER&quot; ]] &amp;&amp; PID_FOLDER=&quot;/tmp&quot;</div><div class="line">	! [[ -x &quot;$LOG_FOLDER&quot; ]] &amp;&amp; LOG_FOLDER=&quot;/tmp&quot;</div><div class="line">	</div><div class="line">	# Setup defaults</div><div class="line">	[[ -z &quot;$MODE&quot; ]] &amp;&amp; MODE=&quot;auto&quot; # modes are &quot;auto&quot;, &quot;service&quot; or &quot;run&quot;</div><div class="line">	</div><div class="line">	# Create an identity for log/pid files</div><div class="line">	if [[ -z &quot;$identity&quot; ]]; then</div><div class="line">	  if [[ -n &quot;$init_script&quot; ]]; then</div><div class="line">	    identity=&quot;$&#123;init_script&#125;&quot;</div><div class="line">	  else</div><div class="line">	    identity=$(basename &quot;$&#123;jarfile%.*&#125;&quot;)_$&#123;jarfolder//\//&#125;</div><div class="line">	  fi</div><div class="line">	fi</div><div class="line">	</div><div class="line">	# Initialize log file name if not provided by the config file</div><div class="line">	[[ -z &quot;$LOG_FILENAME&quot; ]] &amp;&amp; LOG_FILENAME=&quot;$&#123;identity&#125;.log&quot;</div><div class="line">	</div><div class="line">	</div><div class="line">	pom依赖：</div><div class="line">	 </div><div class="line">	&lt;plugin&gt;</div><div class="line">	        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">	        &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</div><div class="line">	        &lt;configuration&gt;</div><div class="line">	            &lt;mainClass&gt;启动类&lt;/mainClass&gt;</div><div class="line">	            &lt;addResources&gt;false&lt;/addResources&gt;</div><div class="line">	            &lt;executable&gt;true&lt;/executable&gt;</div><div class="line">	        &lt;/configuration&gt;</div><div class="line">	        &lt;executions&gt;</div><div class="line">	            &lt;execution&gt;</div><div class="line">	                &lt;goals&gt;</div><div class="line">	                    &lt;goal&gt;repackage&lt;/goal&gt;</div><div class="line">	                &lt;/goals&gt;</div><div class="line">	                &lt;id&gt;1&lt;/id&gt;</div><div class="line">	            &lt;/execution&gt;</div><div class="line">	        &lt;/executions&gt;</div><div class="line">	    &lt;/plugin&gt;</div><div class="line">	``` 	</div><div class="line"></div><div class="line">- 5.maven -Ponline 不生效问题 mvn clean compile -Plocal 配置打不进去</div></pre></td></tr></table></figure>
<p>  <plugin></plugin></p>
<pre><code>&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
&lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
&lt;configuration&gt;
    &lt;!-- spring-boot工程修改了默认的占位符${...}为@...@,修改会默认配置--&gt;
    &lt;useDefaultDelimiters&gt;true&lt;/useDefaultDelimiters&gt;
&lt;/configuration&gt;
</code></pre><p>  </p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line">- 6.创建banner</div></pre></td></tr></table></figure>
<p>  1.在src/main/resource 下创建一个banner.txt文件<br>  2.生成的字符 放入banner.txt中<br>  public interface Banner {</p>
<pre><code>void printBanner(Environment var1, Class&lt;?&gt; var2, PrintStream var3);

public static enum Mode {
    OFF,
    CONSOLE,
    LOG;

    private Mode() {
    }
}
</code></pre><p>  }<br>  生成logo网站：<a href="http://patorjk.com/software/taag/#p=display&amp;f=Graffiti&amp;t=Type%20Something%20" target="_blank" rel="external">http://patorjk.com/software/taag/#p=display&amp;f=Graffiti&amp;t=Type%20Something%20</a></p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line">- 7.当前项目所有类只有一个main函数</div></pre></td></tr></table></figure>
<p>  不然报以下错误:<br>  spring-boot-maven-plugin:1.4.6.RELEASE:repackage failed: Unable to find a single main class from the following candidates<br>  ```</p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/29/9.4) redis-客户端超时问题/" itemprop="url">
                  redis客户端超时分析
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-29T09:37:35+08:00" content="2017-08-29">
              2017-08-29
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="常见的redis超时分析"><a href="#常见的redis超时分析" class="headerlink" title="常见的redis超时分析"></a>常见的redis超时分析</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(1). 网络原因：比如是否存在跨机房、网络割接等等。</div><div class="line">(2). 慢查询，因为redis是单线程，如果有慢查询的话，会阻塞住之后的操作。 </div><div class="line">(3). value值过大？比如value几十兆，当然这种情况比较少，其实也可以看做是慢查询的一种</div><div class="line">(4). aof重写/rdb fork发生？瞬间会堵一下Redis服务器。</div><div class="line">(5). redis自身阻塞（swap fsync 磁盘io hugePage内存页未关闭）</div><div class="line">(5). 其他..................</div></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/08/29/9.4) redis-客户端超时问题/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/23/9.2).redis工具使用/" itemprop="url">
                  redis常用工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-23T16:37:35+08:00" content="2017-08-23">
              2017-08-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="redis常用工具"><a href="#redis常用工具" class="headerlink" title="redis常用工具"></a>redis常用工具</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">环境准备:（注:不同redis版本可能会有差异）</div><div class="line"></div><div class="line">1.redis-server -v</div><div class="line">Redis server v=3.0.7 sha=00000000:0 malloc=jemalloc-3.6.0 bits=64 build=fde71d6d37f8bceb</div><div class="line"></div><div class="line">2.python -V </div><div class="line">Python 2.7.3</div><div class="line">下载：wget https://www.python.org/ftp/python/2.7.3/Python-2.7.3.tar.bz2</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">3.python redis安装 rediscluster安装</div><div class="line"></div><div class="line">wget https://github.com/andymccurdy/redis-py/archive/2.10.5.zip</div><div class="line">unzip 2.10.5.zip</div><div class="line">cd redis-2.10.5</div><div class="line">python setup.py install</div><div class="line"></div><div class="line">wget https://github.com/Grokzen/redis-py-cluster/releases/download/1.3.4/redis-py-cluster-1.3.4.tar.gz</div><div class="line">tar -xvf redis-py-cluster-1.3.4.tar.gz</div><div class="line">cd redis-py-cluster-1.3.4</div><div class="line">python setup.py install</div><div class="line"></div><div class="line">4. 导入包</div><div class="line"></div><div class="line">import redis</div><div class="line">import rediscluster</div><div class="line">import sys</div></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/08/23/9.2).redis工具使用/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/22/9.3) redis运维-python环境安装/" itemprop="url">
                  redis python环境安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-22T10:52:03+08:00" content="2017-08-22">
              2017-08-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="redis-python环境安装"><a href="#redis-python环境安装" class="headerlink" title="redis-python环境安装"></a>redis-python环境安装</h1><p>这里使用python脚本主要是为了提供提供redis小工具使用，包括扫描 特定key，空闲key，bigkey,删除相关key 或 热点key等等。这是在使用过程遇到问题，总结一下。</p>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/08/22/9.3) redis运维-python环境安装/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/21/9.1).redis运维-docker机器用户权限篡改/" itemprop="url">
                  docker机器篡改用户uid
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-21T10:37:35+08:00" content="2017-08-21">
              2017-08-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/cachecloud/" itemprop="url" rel="index">
                    <span itemprop="name">cachecloud</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="docker机器篡改用户uid"><a href="#docker机器篡改用户uid" class="headerlink" title="docker机器篡改用户uid"></a>docker机器篡改用户uid</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">1.原因描述：</div><div class="line">cachecloud管理机器：默认创建用户 cachecloud 内网(cachecloud-open 开源用户)，系统默认分配uid为500以上，位于同一台物理机的容器同样的uid用户太多就会超出用户资源资源超出了，系统就会去修改原来的uid。最好指定下吧，范围最好是500以内的，docker这个用户隔离做的弱。</div><div class="line"></div><div class="line">2.查看用户名的uid</div><div class="line">cat /etc/passwd | grep cachecloud  </div><div class="line">cachecloud:x:504:504::/home/cachecloud:/bin/bash （cachecloud与uid=507绑定）</div><div class="line">启动redis实例 则以cachecloud用户进程启动，ps 查看第一列其实就是以504 uid启动</div><div class="line">[@expon-9 /data/cachecloud]# ps -ef | grep redis</div><div class="line">504       3724     1  0 May25 ?        01:36:07 redis-server 0.0.0.0:6381 [cluster]</div><div class="line">504       4705     1  0 Jun12 ?        01:55:42 redis-server *:6385 [sentinel]</div><div class="line">504       7647     1  0 May25 ?        01:50:45 redis-server 0.0.0.0:6383 [cluster]</div><div class="line">504       7695     1  0 May25 ?        01:57:46 redis-server 0.0.0.0:6384 [cluster]</div><div class="line"></div><div class="line">3.指定uid</div><div class="line">创建指定用户uid:useradd -u $&#123;uid&#125;</div><div class="line">修改指定用户uid:usermod -u $&#123;uid&#125;</div></pre></td></tr></table></figure>
          <div class="post-more-link text-center">
            <a class="btn" href="/2017/08/21/9.1).redis运维-docker机器用户权限篡改/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/08/11/9.5) redis运维-升级redis密码过程/" itemprop="url">
                  cachecloud在线升级密码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-08-11T16:37:35+08:00" content="2017-08-11">
              2017-08-11
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/redis/cachecloud/" itemprop="url" rel="index">
                    <span itemprop="name">cachecloud</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="cachecloud在线升级密码"><a href="#cachecloud在线升级密码" class="headerlink" title="cachecloud在线升级密码"></a>cachecloud在线升级密码</h1><h2 id="在线升级过程"><a href="#在线升级过程" class="headerlink" title="在线升级过程"></a>在线升级过程</h2><ul>
<li>1.【cc客户端】1.确认依赖该appid服务升级，可以先逐步升级cachecloud-client-redis 1.7.0-SNAPSHOT版本，不影响客户端正常使用(无密码连接)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;dependency&gt; </div><div class="line">    &lt;groupId&gt;com.sohu.tv&lt;/groupId&gt; </div><div class="line">    &lt;artifactId&gt;cachecloud-client-redis&lt;/artifactId&gt; </div><div class="line">    &lt;version&gt;1.7.0-SNAPSHOT&lt;/version&gt; </div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<ul>
<li>2.客户端依赖检查</li>
</ul>
<p>确保升级版本cachecloud-client-redis 1.7.0-SNAPSHOT,jedis 2.9.0-CC-3-SNAPSHOT,jedis-common 1.2.2-SNAPSHOT,cachecloud-client-basic 1.1-SNAPSHOT</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[INFO]\- com.sohu.tv:cachecloud-client-redis:jar:1.7.0-SNAPSHOT:compile</div><div class="line">[INFO]    +- redis.clients:jedis:jar:2.9.0-CC-3-SNAPSHOT:compile</div><div class="line">[INFO]    |  +- org.apache.commons:commons-pool2:jar:2.4.2:compile</div><div class="line">[INFO]    |  \- com.sohu.tv:jedis-common:jar:1.2.2-SNAPSHOT:compile</div><div class="line">[INFO]    \- com.sohu.tv:cachecloud-client-basic:jar:1.1-SNAPSHOT:compile</div><div class="line">[INFO]       \- com.alibaba:fastjson:jar:1.2.28:compile</div></pre></td></tr></table></figure>
<ul>
<li><p>3.【cc客户端】3.如果客户端依赖跨机房redis:请升级cachecloud-client-crossroom-redis到1.3-SNAPSHOT</p>
</li>
<li><p>4.【cc客户端】4.提交申请密码配置工单，应用首页-申请修改配置  里注明即可(“申请配置应用密码“)</p>
</li>
<li><p>5.【cc后台】5.cachechcloud确认所有客户端最新上报版本以及redis版本，准备配置密码 观察日志</p>
</li>
</ul>
<p>运维对密码修改:<br><img src="http://i2.itc.cn/20170920/aac_68fe4d07_8bee_c0e8_0e16_6f573477609e_1.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">更新:这个过程是对当前redis所有实例进行密码配置</div><div class="line">校验:这个过程是为校验每个redis实例上密码是否和设置密码一致</div><div class="line"></div><div class="line">密码设置规则: md5(key+&#123;appId&#125;)</div></pre></td></tr></table></figure>
<ul>
<li><p>6.【cc后台】6.后台配置密码后,appid对应cluster/sentinel/standalone所有redis节点密码生效，客户端jedis连接异常后会自动重连 拉取埋点密码重试成功(重连成功后为有密码连接)</p>
</li>
<li><p>7.客户端可在应用首页查看应用密码<br><img src="http://i0.itc.cn/20170920/aac_68fe4d07_8bee_c0e8_0e16_6f573477609e_2.png" alt=""></p>
</li>
</ul>
<h2 id="jedis源码改造"><a href="#jedis源码改造" class="headerlink" title="jedis源码改造"></a>jedis源码改造</h2><blockquote>
<p>1.改造Jedis</p>
</blockquote>
<p>优点:升级sdk支持在线切换，数据没有丢失。缺点：只支持Jedis，其他接入方式需要手动修改修改密码，密码生成过程固定。</p>
<ul>
<li>a.standalone 模式: 改造JeidsPool.makeObject.</li>
<li>b.cluster 模式: 集群内所有节点使用同一密码，防止failover失败。Jedis改造<br>JedisClusterConnectionHandler.initializeSlotsCache 方法。</li>
<li>c.sentinel模式:  主从所有节点必须使用同一个密码。改造JedisSentinelPool.initPool </li>
<li>d.支持失败判定：NOAUTH Authentication required 异常后，中断连接下次重连。</li>
</ul>
<blockquote>
<p>2.RESTful请求携带密码。</p>
</blockquote>
<p>优点:不需要改造客户端，密码生成规则灵活 缺点：升级协同困难。</p>
<ul>
<li>a.RESTful数据中密码字段使用对称加密，防止直接传输明文。</li>
<li>b.客户端sdk加入判断是否设置密码功能。</li>
</ul>
<blockquote>
<p>3.在线修改密码:</p>
</blockquote>
<ul>
<li>a.redis客户端连接未使用密码时，修改密码后报错需要重连。</li>
<li>b.redis客户端连接使用密码连接时，修改密码原有连接继续可用。</li>
</ul>
<h2 id="升级过程问题"><a href="#升级过程问题" class="headerlink" title="升级过程问题"></a>升级过程问题</h2><ul>
<li><ol>
<li>为什么要升级到cachecloud-client-redis 1.7.0-SNAPSHOT?</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1.jedis客户端相关代码改造以及cachecloud相关依赖改造，需要重新获取依赖，才能支持密码在线升级。</div><div class="line">2.提前埋点到RESTful-API: 可支持无密码/默认密码/动态密码模式。</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>如何实现在线升级支持redis密码？</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1.客户端更新服务依赖后重启服务，此时cachecloud-client-redis 1.7.0-SNAPSHOT可以支持密码功能。</div><div class="line">2.cc后台设置密码，appid对应所有redis实例密码生效，此时客户端原来无密码连接报错。</div><div class="line">3.客户端抛出异常后会重试，新建连接会获取埋点默认密码，重新连接redis。</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>cachecloud-client-redis已经升级到1.7.0-SNAPSHOT，但是上报cachecloud版本仍然是1.4?</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">10.10.193.153 - - [28/Aug/2017:10:58:34 +0800] &quot;GET /cache/client/redis/cluster/10380.json?clientVersion=1.4-SNAPSHOT HTTP/1.1&quot; 200 298 &quot;-&quot; &quot;Java/1.8.0_101&quot; &quot;-&quot; &quot;0.010&quot; &quot;0.011&quot;</div><div class="line">10.10.193.153 - - [28/Aug/2017:14:45:10 +0800] &quot;GET /cache/client/redis/cluster/10380.json?clientVersion=1.4-SNAPSHOT HTTP/1.1&quot; 200 298 &quot;-&quot; &quot;Java/1.8.0_101&quot; &quot;-&quot; &quot;0.010&quot; &quot;0.011&quot;</div><div class="line">10.10.193.153 - - [28/Aug/2017:14:59:16 +0800] &quot;GET /cache/client/redis/cluster/10380.json?clientVersion=1.4-SNAPSHOT HTTP/1.1&quot; 200 298 &quot;-&quot; &quot;Java/1.8.0_101&quot; &quot;-&quot; &quot;0.011&quot; &quot;0.013&quot;</div><div class="line">10.10.193.153 - - [28/Aug/2017:15:57:28 +0800] &quot;GET /cache/client/redis/cluster/10380.json?clientVersion=1.4-SNAPSHOT HTTP/1.1&quot; 200 298 &quot;-&quot; &quot;Java/1.8.0_101&quot; &quot;-&quot; &quot;4.009&quot; &quot;4.010&quot;</div><div class="line"></div><div class="line">a.如果是只是依赖cachecloud-client-redis1.7.0-SNAPSHOT ，确认cachecloud-client-basic</div><div class="line">是否为1.1-SNAPSHOT,不是的话 需要做mvn -U 重新拉取下依赖.</div><div class="line"></div><div class="line">b.如果依赖cachecloud-client-redis1.7.0-SNAPSHOT 还依赖跨机房包cachecloud-client-</div><div class="line">crossroom-redis，会有cachecloud-client-basic包冲突，请检查crossroom-redis版本是否升</div><div class="line">级到1.3-SNAPSHOT</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>使用sentinel pool,在线升级密码之后客户端一直抛出jedisConnectionException NOAUTH异常?</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">检查客户端使用sentinelPool 关闭连接的方式 确保使用的下面第2种方式：</div><div class="line">try &#123;</div><div class="line">    //获取连接</div><div class="line">    jedis = sentinelPool.getResource();</div><div class="line">    String key = &quot;test&quot;;</div><div class="line">    System.out.println(&quot;get &quot; + key + &quot; ,value =&quot; + jedis.get(key));</div><div class="line">&#125; catch (Exception e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125; finally &#123;</div><div class="line">    // 第1种.不支持中断的归还连接 （问题在这）</div><div class="line">    // jedisSentinelPool.returnResource(jedis);</div><div class="line">    // 第2种.支持中断的归还连接</div><div class="line">    if (jedis != null) &#123;</div><div class="line">        jedis.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>master-slave 主从结构在升级密码期间，会发生什么?</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">master：10.10.193.189:6380  slave:10.10.193.148:6381</div><div class="line"></div><div class="line">a.master设置密码后，slave与master为断开,master redis log:</div><div class="line">27192:M 19 Sep 10:01:36.554 # Disconnecting timedout slave: 10.10.193.148:6381</div><div class="line">27192:M 19 Sep 10:01:36.554 # Connection with slave 10.10.193.148:6381 lost.</div><div class="line">1).master添加密码成功,slave表现为断开状态</div><div class="line">27192:M 19 Sep 10:01:36.982 * Slave 10.10.193.148:6381 asks for synchronization</div><div class="line">27192:M 19 Sep 10:01:36.982 * Unable to partial resync with slave 10.10.193.148:6381 for lack of backlog (Slave request was: 188517104780).</div><div class="line">27192:M 19 Sep 10:01:36.982 # Warning: slave 10.10.193.148:6381 tried to PSYNC with an offset that is greater than the master replication offset.</div><div class="line">4).slave请求同步master,master返回不能进行部分复制,原因是slave复制偏移量大于master偏移量)</div><div class="line">27192:M 19 Sep 10:01:36.982 * Starting BGSAVE for SYNC with target: disk</div><div class="line">27192:M 19 Sep 10:01:37.026 * Background saving started by pid 23211</div><div class="line">7).master做全量复制，fork子进程 开始生成rdb文件</div><div class="line">23211:C 19 Sep 10:01:47.077 * DB saved on disk</div><div class="line">23211:C 19 Sep 10:01:47.118 * RDB: 52 MB of memory used by copy-on-write</div><div class="line">27192:M 19 Sep 10:01:47.181 * Background saving terminated with success</div><div class="line">8).rdb文件生成，copyonwrite内存开销为52M，开始同步</div><div class="line">27192:M 19 Sep 10:01:54.237 * Synchronization with slave 10.10.193.148:6381 succeeded</div><div class="line">10).数据发送slave成功</div><div class="line"></div><div class="line">b.slave密码设置成功,slave redis log:</div><div class="line"></div><div class="line">27928:S 19 Sep 10:01:36.555 # Connection with master lost.</div><div class="line">27928:S 19 Sep 10:01:36.555 * Caching the disconnected master state.</div><div class="line">2).由于slave表现为断开</div><div class="line">27928:S 19 Sep 10:01:36.982 * Connecting to MASTER 10.10.193.189:6380</div><div class="line">27928:S 19 Sep 10:01:36.982 * MASTER &lt;-&gt; SLAVE sync started</div><div class="line">27928:S 19 Sep 10:01:36.982 * Non blocking connect for SYNC fired the event.</div><div class="line">27928:S 19 Sep 10:01:36.983 * Master replied to PING, replication can continue...</div><div class="line">27928:S 19 Sep 10:01:36.983 * Trying a partial resynchronization (request 0434b4b3476903d92c67bdb3615bce8e456afbf3:188517104780).</div><div class="line">3).slave密码设置成功，开始重连master节点,发起部分复制请求</div><div class="line">27928:S 19 Sep 10:01:37.027 * Full resync from master: 0434b4b3476903d92c67bdb3615bce8e456afbf3:188517104247</div><div class="line">27928:S 19 Sep 10:01:37.027 * Discarding previously cached master state.</div><div class="line">6).master返回状态 需要全量复制,master runid offset:0434b4b3476903d92c67bdb3615bce8e456afbf3:188517104247</div><div class="line">27928:S 19 Sep 10:01:47.182 * MASTER &lt;-&gt; SLAVE sync: receiving 538594334 bytes from master</div><div class="line">9).接收master数据:538MB</div><div class="line">27928:S 19 Sep 10:01:54.294 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</div><div class="line">27928:S 19 Sep 10:02:01.721 * MASTER &lt;-&gt; SLAVE sync: Loading DB in memory</div><div class="line">27928:S 19 Sep 10:02:30.924 * MASTER &lt;-&gt; SLAVE sync: Finished with success</div><div class="line">11).加载rdb数据到内存成功</div><div class="line">27928:S 19 Sep 10:02:30.958 * Background append only file rewriting started by pid 31740</div><div class="line">27928:S 19 Sep 10:02:35.288 * AOF rewrite child asks to stop sending diffs.</div><div class="line">31740:C 19 Sep 10:02:35.288 * Parent agreed to stop sending diffs. Finalizing AOF...</div><div class="line">31740:C 19 Sep 10:02:35.288 * Concatenating 0.40 MB of AOF diff received from parent.</div><div class="line">31740:C 19 Sep 10:02:35.289 * SYNC append only file rewrite performed</div><div class="line">31740:C 19 Sep 10:02:35.325 * AOF rewrite: 117 MB of memory used by copy-on-write</div><div class="line">27928:S 19 Sep 10:02:35.472 * Background AOF rewrite terminated with success</div><div class="line">12).fork子进程做bgrewriteAof,重写aof文件</div><div class="line">27928:S 19 Sep 10:02:35.473 * Residual parent diff successfully flushed to the rewritten AOF (0.00 MB)</div><div class="line">27928:S 19 Sep 10:02:35.473 * Background AOF rewrite finished successfully</div><div class="line">13).AOF重写缓冲区增量新数据同步成功(copyonwrite复制技术，子进程只能共享fork操作时的内存数据aof_buffer，增量数据在aof_rewrite_buffer)</div></pre></td></tr></table></figure>
<p>主从密码升级过程中，slave在添加密码过程，master会做一次全量复制.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Warning: slave 10.10.193.148:6381 tried to PSYNC with an offset that is </div><div class="line">greater than the master replication offset.</div></pre></td></tr></table></figure></p>
<p>看master日志,slave在请求部分复制失败，master返回全量复制状态，这个问题好像是redis的一个bug,主节点设置完密码后，从节点的slave_repl_offset在自己增长，slave_repl_offset代表slave缓存的主节 点的offset。</p>
<p>github查下相关问题:<br><a href="https://github.com/antirez/redis/issues/3" target="_blank" rel="external">https://github.com/antirez/redis/issues/3</a> </p>
<p><a href="https://github.com/antirez/redis/issues/1969" target="_blank" rel="external">https://github.com/antirez/redis/issues/1969</a></p>
<ul>
<li>6.在线加密码后，客户端抛出jedisConnectionException NOAUTH异常原因?</li>
</ul>
<p><strong>客户端异常信息</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">2017-09-19 10:00:44,046 [DataComponentCommand.java:65] [ERROR] NOAUTH Authentication required.</div><div class="line">redis.clients.jedis.exceptions.JedisConnectionException: NOAUTH Authentication required.</div><div class="line">        at redis.clients.jedis.Protocol.processError(Protocol.java:131) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.Protocol.process(Protocol.java:167) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.Protocol.read(Protocol.java:221) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.Connection.readProtocolWithCheckingBroken(Connection.java:328) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.Connection.getIntegerReply(Connection.java:274) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.Jedis.hdel(Jedis.java:842) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisCluster$35.execute(JedisCluster.java:445) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisCluster$35.execute(JedisCluster.java:442) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisClusterCommand.runWithRetries(JedisClusterCommand.java:128) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisClusterCommand.runWithRetries(JedisClusterCommand.java:149) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisClusterCommand.runWithRetries(JedisClusterCommand.java:149) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisClusterCommand.runWithRetries(JedisClusterCommand.java:149) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisClusterCommand.runWithRetries(JedisClusterCommand.java:149) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisClusterCommand.run(JedisClusterCommand.java:36) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at redis.clients.jedis.JedisCluster.hdel(JedisCluster.java:447) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div><div class="line">        at com.sohu.tv.cachecloud.client.redis.crossroom.impl.RedisClusterCrossRoomClientImpl$33.writeMinor(RedisClusterCrossRoomClientImpl.java:724) ~[cachecloud-client-crossroo</div><div class="line">m-redis-1.3-20170829.034859-7.jar:na]</div><div class="line">        at com.sohu.tv.cachecloud.client.redis.crossroom.impl.RedisClusterCrossRoomClientImpl$33.writeMinor(RedisClusterCrossRoomClientImpl.java:716) ~[cachecloud-client-crossroo</div><div class="line">m-redis-1.3-20170829.034859-7.jar:na]</div></pre></td></tr></table></figure>
<blockquote>
<p>首先需要理解redis通讯过程: 1.建立socket连接 2.发送命名等待返回</p>
</blockquote>
<p>大部分客户端使用的redis cluster，以set命令为例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public String set(final String key, final String value) &#123;</div><div class="line">    return (String)(new JedisClusterCommand(this.connectionHandler, this.maxAttempts) &#123;</div><div class="line">        public String execute(Jedis connection) &#123;</div><div class="line">            return connection.set(key, value);</div><div class="line">        &#125;</div><div class="line">    &#125;).run(key);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>过程1:建立socket连接过程 JedisClusterCommand 包一层 执行run</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">核心代码:</div><div class="line">private T runWithRetries(byte[] key, int attempts, boolean tryRandomNode, boolean asking) &#123;</div><div class="line">    if(attempts &lt;= 0) &#123;</div><div class="line">        JedisClusterMaxRedirectionsException connection1 = new JedisClusterMaxRedirectionsException(&quot;Too many Cluster redirections? key=&quot; + SafeEncoder.encode(key));</div><div class="line">        ....</div><div class="line">        throw connection1;</div><div class="line">    &#125; else &#123;</div><div class="line">    	 // 创建socket connection过程</div><div class="line">        Jedis connection = null;</div><div class="line"></div><div class="line">        Object var7;</div><div class="line">        try &#123;</div><div class="line">            if(asking) &#123;</div><div class="line">                connection = (Jedis)this.askConnection.get();</div><div class="line">                connection.asking();</div><div class="line">                asking = false;</div><div class="line">            &#125; else if(tryRandomNode) &#123;</div><div class="line">                connection = this.connectionHandler.getConnection();</div><div class="line">            &#125; else &#123;</div><div class="line">                connection = this.connectionHandler.getConnectionFromSlot(JedisClusterCRC16.getSlot(key));</div><div class="line">            &#125;</div><div class="line">            Object jre = this.execute(connection);</div><div class="line">            return jre;</div><div class="line">        &#125; catch (JedisNoReachableClusterNodeException var13) &#123;</div><div class="line">            throw var13;</div><div class="line">        &#125; catch (JedisConnectionException var14) &#123;</div><div class="line">            this.releaseConnection(connection);</div><div class="line">            connection = null;</div><div class="line">            if(attempts &lt;= 1) &#123;</div><div class="line">                this.connectionHandler.renewSlotCache();</div><div class="line">                throw var14;</div><div class="line">            &#125;</div><div class="line">            var7 = this.runWithRetries(key, attempts - 1, tryRandomNode, asking);</div><div class="line">        &#125; catch (JedisRedirectionException var15) &#123;</div><div class="line">            .....</div><div class="line">        &#125; finally &#123;</div><div class="line">            this.releaseConnection(connection);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return var7;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>过程2:发送命令等待返回：connection.set(key, value);</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public String set(String key, String value) &#123;</div><div class="line">    this.checkIsInMultiOrPipeline();</div><div class="line">    this.client.set(key, value);</div><div class="line">    return this.client.getStatusCodeReply();</div><div class="line">&#125;</div><div class="line"></div><div class="line">protected Object readProtocolWithCheckingBroken() &#123;</div><div class="line">        Object o = null;</div><div class="line">        boolean var10 = false;</div><div class="line"></div><div class="line">        Object exc;</div><div class="line">        try &#123;</div><div class="line">            // 等待流返回结果</div><div class="line">            var10 = true;</div><div class="line">            o = Protocol.read(this.inputStream);</div><div class="line">            exc = o;</div><div class="line">            var10 = false;</div><div class="line">        &#125; catch (JedisConnectionException var11) &#123;</div><div class="line">           ....</div><div class="line">        &#125; finally &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">        ....</div><div class="line">        return exc;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>分析原因:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">redis.clients.jedis.Connection.readProtocolWithCheckingBroken(Connection.java:328) ~[jedis-2.9.0-CC-3-20170821.084013-2.jar:na]</div></pre></td></tr></table></figure>
<p>根据异常日志，发现连接在建立是没有问题，但是执行命令返回抛出异常，也就是在加密码过程中 过程1 ok ，过程二 执行命令 需要密码报错。<br>过程1:建立socket报错，cluster自身默认5次重试，重试失败抛出Too many Cluster redirections?<br>过程2:建立socket连接，执行命令读取报错，则抛出以上异常信息。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/06/(8.5).JAVA虚拟机(五)-JVM性能调优及故障排查/" itemprop="url">
                  java虚拟机-故障排查
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-06T16:37:35+08:00" content="2016-08-06">
              2016-08-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="JVM常见问题及性能分析"><a href="#JVM常见问题及性能分析" class="headerlink" title="JVM常见问题及性能分析"></a>JVM常见问题及性能分析</h2><p>你遇到过这些问题吗？</p>
<pre><code>OOM: Heap, Stack, Perm
系统频繁GC
Java进程占用CPU过高
Java占用内存增长很快
远程调用timeout
系统响应时间变长，越来越慢
……
</code></pre><h3 id="方法一：GC-log"><a href="#方法一：GC-log" class="headerlink" title="方法一：GC log"></a>方法一：GC log</h3><ul>
<li>1.开启GC日志：-XX:+PrintGCDetails (包含-XX:+PrintGC -verbose:gc )</li>
<li>2.GC触发时间：-XX:+PrintGCDateStamps/-XX:+PrintGCTimeStamps </li>
<li><p>3.日志存放位置：-Xloggc:/path/gc.log</p>
<pre><code>配置JVM参数：
-XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintGCDateStamps 
-Xloggc:D:/logs/gc/gc.log 
</code></pre></li>
</ul>
<p>输出日志：</p>
<p>2016-03-08T16:11:05.446+0800: 8.861: [GC2016-03-08T16:11:05.446+0800: 8.861: [ParNew: 46080K-&gt;5120K(46080K), 0.0177669 secs] 66765K-&gt;28892K(97280K), 0.0178659 secs] [Times: user=0.03 sys=0.00, real=0.02 secs]<br>2016-03-08T17:01:01.930+0800: 375.874: [Full GC2016-03-08T17:01:01.930+0800: 375.874: [CMS: 40535K-&gt;40535K(51200K), 0.1600130 secs] 79475K-&gt;59991K(97280K), [CMS Perm : 36535K-&gt;36535K(51200K)], 0.1601362 secs] [Times: user=0.16 sys=0.00, real=0.16 secs] </p>
<p>可参考：</p>
<p>官网：<a href="https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs" target="_blank" rel="external">https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs</a></p>
<p>并发编程网：<a href="http://ifeve.com/jvm-cms-log/" target="_blank" rel="external">http://ifeve.com/jvm-cms-log/</a></p>
<h3 id="方法二：jdk自带命令"><a href="#方法二：jdk自带命令" class="headerlink" title="方法二：jdk自带命令"></a>方法二：jdk自带命令</h3><pre><code>jps  ： jps可以理解为java的ps，用于显示java进程 ,-v 输出虚拟机启动的时的参数   
        jps –v pid       
jinfo：jinfo查看和调整虚拟机的各项参数   
        jinfo  pid
jmap ：jmap生成堆转存快照文件
        jmap –heap pid显示Java堆详细信息，如使用哪种回收器，参数配置、分代状况
jstat：jstat 统计信息监视工具
       jstat –gcutil pid  主要关注已使用空间占总空间的百分比
jstack：jstack生成当前时刻线程快照
        jstack pid 
         检测cpu使用率飙高时三个步骤： 
           1.查该进程最高的线程  top –Hp pid
           2.转换最高线程id 为16进程
           3.查看堆栈对应线程id的堆栈信息
</code></pre><blockquote>
<p>性能调试：</p>
</blockquote>
<pre><code>cd `dirname $0`
PID=$1
BIN_DIR=`pwd`
cd $BIN_DIR
DUMP_DIR=./
DUMP_DATE=`date +%Y%m%d%H%M%S`
DATE_DIR=$DUMP_DIR/$DUMP_DATE
if [ ! -d $DATE_DIR ]; then
        mkdir $DATE_DIR
fi

echo -e &quot;Dumping the jdump ...\c&quot;
jstack $PID &gt; $DATE_DIR/jstack-$PID.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
jinfo $PID &gt; $DATE_DIR/jinfo-$PID.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
jstat -gcutil $PID &gt; $DATE_DIR/jstat-gcutil-$PID.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
jstat -gccapacity $PID &gt; $DATE_DIR/jstat-gccapacity-$PID.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
jmap $PID &gt; $DATE_DIR/jmap-$PID.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
jmap -heap $PID &gt; $DATE_DIR/jmap-heap-$PID.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
jmap -histo $PID &gt; $DATE_DIR/jmap-histo-$PID.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
if [ -r /usr/sbin/lsof ]; then
/usr/sbin/lsof -p $PID &gt; $DATE_DIR/lsof-$PID.dump
echo -e &quot;.\c&quot;
fi

if [ -r /bin/netstat ]; then
/bin/netstat -an &gt; $DATE_DIR/netstat.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
fi
if [ -r /usr/bin/iostat ]; then
/usr/bin/iostat &gt; $DATE_DIR/iostat.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
fi
if [ -r /usr/bin/mpstat ]; then
/usr/bin/mpstat -P ALL &gt; $DATE_DIR/mpstat.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
fi
if [ -r /usr/bin/vmstat ]; then
/usr/bin/vmstat &gt; $DATE_DIR/vmstat.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
fi
if [ -r /usr/bin/free ]; then
/usr/bin/free -t &gt; $DATE_DIR/free.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
fi
if [ -r /usr/bin/sar ]; then
/usr/bin/sar &gt; $DATE_DIR/sar.dump 2&gt;&amp;1
echo -e &quot;.\c&quot;
fi
if [ -r /usr/bin/uptime
</code></pre><h3 id="方法三：java工具分析"><a href="#方法三：java工具分析" class="headerlink" title="方法三：java工具分析"></a>方法三：java工具分析</h3><p>Jconsole/JvisualVM/Jprofile/Jmc 等工具对 操作系统(cpu/线程数/内存) 以及jvm分代消耗 gc情况 或 死锁 或 Mbean jmx监控 着手分析</p>
<h2 id="如何进行系统调优"><a href="#如何进行系统调优" class="headerlink" title="如何进行系统调优"></a>如何进行系统调优</h2><h3 id="考虑哪些方面"><a href="#考虑哪些方面" class="headerlink" title="考虑哪些方面"></a>考虑哪些方面</h3><ul>
<li>硬件:<br>  网卡/网络是否通/交换机</li>
<li>操作系统:<br>  负载load/内存mem/swap/io</li>
<li>运行环境软件:<br>  Nginx/Apache/Resin<br>  JVM参数</li>
<li>应用本身<br>  Java程序</li>
</ul>
<pre><code>调查系统现状/寻找性能瓶颈/定位问题
    请求次数
    响应时间
资源消耗：CPU/内存/文件/网络
    确定调优目标
    单机用户量=用户量/机器数
     并发目标：如95%用户500ms响应
定位资源消耗
    -在哪里
        CPU/内存/文件/网络
    -什么类型
        线程调度太频繁
        线程load太高
        Full GC太频繁
        Full GC时间过长
        文件读写太慢、堵塞
定位问题代码
    使用Java工具分析内存、线程
    优化问题代码
    未来：编写高效代码 
</code></pre><h3 id="系统分析"><a href="#系统分析" class="headerlink" title="系统分析"></a>系统分析</h3><blockquote>
<p>cpu消耗分析</p>
</blockquote>
<p>上下文切换：文件IO、网络IO、锁、Sleep<br>运行队列（load）：每个核任务队列，最好1~3<br>利用率（关键指标）：进程、内核、中断处理、IO等待、空闲<br>top命令<br>top按进程显示<br>top –p 29974按进程ID显示<br>top1按核显示<br>topshift+h按线程显示<br>vmstat采样<br>vmstat -1每1秒采样</p>
<p>tsar历史消耗对比</p>
<pre><code>top参数意义
 us用户进程任务：高是线程粒度太大，线程一直处于可运行状态Runabble
     原因1：线程无阻塞、循环、大计算（正则、纯粹大运算）
     原因2：频繁GC(Eden/Old小，新对象占用内存多，YoungGC/Full GC)
定位线程：top -5650shift+h找到线程号26697， 0x6849
       一个线程总占用高： jstack 26697 | grep ‘nid=0x6849’
    多个线程来回切换无法定位：jstack 26697
sy内核线程切换：高是线程太多粒度太小
原因：不断阻塞切换、锁等待、IO等待
定位线程： jstack -l 26697，分析等待状态、锁竞争过多线程
ni为nice改变优先级，id空闲时间
wa等待io：大文件
hi硬件中断：网卡接收数据频繁等
si软件中断

top - 16:57:02 up 98 days,  1:40,  9 users,  load average: 7.71, 9.08, 11.05
Tasks: 279 total,   1 running, 277 sleeping,   0 stopped,   1 zombie
Cpu(s): 27.4%us,  5.1%sy,  0.0%ni, 65.6%id,  1.8%wa,  0.0%hi,  0.0%si,  0.0%st
Mem:  65981472k total, 49901984k used, 16079488k free,  4359276k buffers
Swap:  4192956k total,        0k used,  4192956k free, 23197812k cached
</code></pre><blockquote>
<p>内存消耗分析</p>
</blockquote>
<p>vmstat<br>swpd已用虚拟内存kb：过高表示物理内存不够用<br>原因：JVM内存设置过大，Java线程过多，ByteBuffer过多—-即可定位<br>free空闲物理内存<br>buff用作缓冲内存<br>cache用作缓存内存<br>si每秒从disk读至内存数据量<br>so每秒从内存挟制disk数据量</p>
<pre><code>procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  3      0 15973668 4359360 23257704    0    0     0   123    0    0 27  5 66  2  0
 0  2      0 15974188 4359360 23257732    0    0     0  5092 1878 3922  0  0 93  6  0

swap相关：kbswpfree,kbswpused
物理内存：kbmemfree,kbmemused
实际可用=kbmemfree+kbfuffers缓冲+kbcached缓存

10时00分01秒 kbmemfree kbmemused  %memused kbbuffers  kbcached kbswpfree kbswpused  %swpused  kbswpcad
10时10分01秒  18004796  47976676     72.71   4354120  21700168   4192956         0      0.00         0
10时20分01秒  17919088  48062384     72.84   4354152  21746360   4192956         0      0.00         0

top：显示的是实际占用内存=Heap+Stack+Perm+ByteBuffer

vmstat/sar/top对比
sar优点：比vmstat，可分析历史
vmstat/sar弱点：不能分析进程内存，top可以
top弱点：不易分析实际占用内存
</code></pre><blockquote>
<p>文件IO消耗分析</p>
</blockquote>
<p>iostat -x<br>iowait每次IO等待CPU比例，高是因为一直等不到IO<br>原因1：文件读写文件占用时间长，多个线程需要大量写入（如频繁写日志）<br>原因2：磁盘设备处理速度慢<br>原因3：文件系统慢<br>原因4：操作文件太大<br>定位线程：jstack找到runnable中的线程<br>tps每秒IO请求数<br>Blk_read/s每秒读区块数(512byte)<br>Blk_wrtn/s每秒写区块数<br>Blk_read读区块总数<br>Blk_wrtn写区块总数</p>
<pre><code>avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           2.54    0.00    0.55    0.03    0.00   96.87

Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda              11.17        41.40       417.44  436437014 4400574548
sda1              1.11         0.13        37.17    1356426  391818168
sda2              0.00         0.00         0.00       1424          0
sda3              2.64         1.02        35.43   10714778  373487500
sda4              0.00         0.00         0.00          8          0
sda5              0.65         0.66        23.25    6921378  245057640
sda6              6.78        39.60       321.60  417442456 3390211240

采样iostat -x xvda 3 5
r/s每秒读的请求数
r/s每秒写的请求书
avgqu-sz等待请求队列的平均长度
await每次IO等待时间ms
svctm平均每次设备执行IO操作时间

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
       2.54    0.00    0.55    0.03    0.00   96.87

Device:         rrqm/s   wrqm/s   r/s   w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util
sda               0.13    41.63  0.61 10.56    41.39   417.55    41.07     0.03    2.58   0.32   0.36
sda1              0.01     3.54  0.00  1.11     0.13    37.17    33.58     0.00    1.01   0.31   0.03
sda2              0.00     0.00  0.00  0.00     0.00     0.00    54.77     0.00    5.08   4.62   0.00
sda3              0.02     1.81  0.02  2.62     1.02    35.43    13.83     0.00    0.30   0.20   0.05
sda4              0.00     0.00  0.00  0.00     0.00     0.00     2.00     0.00   12.00  12.00   0.00
sda5              0.01     2.29  0.03  0.62     0.66    23.25    36.71     0.00    0.98   0.37   0.02
sda6              0.10    33.99  0.56  6.22    39.59   321.69    53.32     0.03    3.88   0.42   0.28
</code></pre><blockquote>
<p>网络IO消耗分析</p>
</blockquote>
<p>cat /proc/interrupts：查看网卡中断是否均衡分配到各CPU<br>只分配到一个CPU：修改kernel，或用支持MSI-X网卡<br>tcpdump -i eth0 -s 0 -l -w - dst port 11214 | strings | grep test_<br>sar -n ALL 1 2：统计收发包成功失败数量<br>网卡成功接包、发包信息<br>网卡失败接包、发包信息(ping)<br>socket统计信息</p>
<pre><code>18时38分08秒     IFACE   rxpck/s   txpck/s   rxbyt/s   txbyt/s   rxcmp/s   txcmp/s  rxmcst/s
18时38分09秒        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00
18时38分09秒      eth0    581.00    703.00 107914.00  89316.00      0.00      0.00      0.00
18时38分09秒      eth1      8.00      0.00    512.00      0.00      0.00      0.00      0.00
18时38分09秒      usb0      0.00      0.00      0.00      0.00      0.00      0.00      0.00

18时38分08秒     IFACE   rxerr/s   txerr/s    coll/s  rxdrop/s  txdrop/s  txcarr/s  rxfram/s  rxfifo/s  txfifo/s
18时38分09秒        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
18时38分09秒      eth0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
18时38分09秒      eth1      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
18时38分09秒      usb0      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00

18时38分08秒    call/s retrans/s    read/s   write/s  access/s  getatt/s
18时38分09秒      0.00      0.00      0.00      0.00      0.00      0.00
</code></pre><h2 id="命令分析"><a href="#命令分析" class="headerlink" title="命令分析"></a>命令分析</h2><p>堆栈分析线程状态(blocked，time_waiting, Waiting)<br>可参考：<a href="http://www.cnblogs.com/zhengyun_ustc/archive/2013/03/18/tda.html" target="_blank" rel="external">http://www.cnblogs.com/zhengyun_ustc/archive/2013/03/18/tda.html</a></p>
<h3 id="线程状态查看"><a href="#线程状态查看" class="headerlink" title="线程状态查看"></a>线程状态查看</h3><p>jstack 21415 | grep -i “java.lang.Thread.State” | sort | uniq -c</p>
<pre><code>13    java.lang.Thread.State: BLOCKED (on object monitor)
 21    java.lang.Thread.State: RUNNABLE
 70    java.lang.Thread.State: TIMED_WAITING (on object monitor)
  4    java.lang.Thread.State: TIMED_WAITING (parking)
  6    java.lang.Thread.State: TIMED_WAITING (sleeping)
 13    java.lang.Thread.State: WAITING (on object monitor)
</code></pre><h3 id="输出jstack日志"><a href="#输出jstack日志" class="headerlink" title="输出jstack日志"></a>输出jstack日志</h3><p>jstack 21415 &gt; jstack.log</p>
<h3 id="查看jstack-BLOCKED状态的锁"><a href="#查看jstack-BLOCKED状态的锁" class="headerlink" title="查看jstack BLOCKED状态的锁"></a>查看jstack BLOCKED状态的锁</h3><p>vim jstack.log</p>
<pre><code>&quot;http--8082-16$1500284796&quot; daemon prio=10 tid=0x00002aabd5f57000 nid=0x5902 waiting for monitor entry [0x0000000043829000]
   java.lang.Thread.State: BLOCKED (on object monitor)
        at java.net.PlainSocketImpl.accept(PlainSocketImpl.java:388)
        - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
        at java.net.ServerSocket.implAccept(ServerSocket.java:453)
        at java.net.ServerSocket.accept(ServerSocket.java:421)
        at com.caucho.vfs.QServerSocketWrapper.accept(QServerSocketWrapper.java:91)
        at com.caucho.server.port.Port.accept(Port.java:1179)
        at com.caucho.server.port.TcpConnection.run(TcpConnection.java:659)
        at com.caucho.util.ThreadPool$Item.runTasks(ThreadPool.java:743)
        at com.caucho.util.ThreadPool$Item.run(ThreadPool.java:662)
        at java.lang.Thread.run(Thread.java:619)
</code></pre><h3 id="查看锁的状态-0x00002aab14c63d10"><a href="#查看锁的状态-0x00002aab14c63d10" class="headerlink" title="查看锁的状态 0x00002aab14c63d10"></a>查看锁的状态 0x00002aab14c63d10</h3><pre><code>[@zjm_106_165 ~]# cat jstack.log.20160719 | grep 0x00002aab14c63d10
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - locked &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
    - waiting to lock &lt;0x00002aab14c63d10&gt; (a java.net.SocksSocketImpl)
</code></pre><h2 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h2><h3 id="tsar"><a href="#tsar" class="headerlink" title="tsar"></a>tsar</h3><h3 id="iftop"><a href="#iftop" class="headerlink" title="iftop"></a>iftop</h3>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/05/(8.6).JAVA虚拟机(六)-JMM内存模型/" itemprop="url">
                  JMM内存模型
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-05T16:37:35+08:00" content="2016-08-05">
              2016-08-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/04/(8.4).JAVA虚拟机(四)-G1垃圾回收器/" itemprop="url">
                  G1 Heap Stucture
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-04T16:37:35+08:00" content="2016-08-04">
              2016-08-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="The-G1-Garbage-Collector-垃圾优先型垃圾回收器"><a href="#The-G1-Garbage-Collector-垃圾优先型垃圾回收器" class="headerlink" title="The G1 Garbage Collector(垃圾优先型垃圾回收器)"></a>The G1 Garbage Collector(垃圾优先型垃圾回收器)</h3><p>The Garbage-First (G1) collector is a server-style garbage collector, targeted for multi-processor machines with large memories. It meets garbage collection (GC) pause time goals with a high probability, while achieving high throughput. The G1 garbage collector is fully supported in Oracle JDK 7 update 4 and later releases. The G1 collector is designed for applications that:</p>
<ul>
<li><p>Can operate concurrently with applications threads like the CMS collector.</p>
<p>  G1像cms收集器一样能够将收集线程和用户线程一起并发处理</p>
</li>
<li><p>Compact free space without lengthy GC induced pause times.</p>
<p>  GC在停顿时间内收集无需要更多的空间    </p>
</li>
<li><p>Need more predictable GC pause durations.</p>
<p>  提供更可靠的GC停顿时间预测</p>
</li>
<li><p>Do not want to sacrifice a lot of throughput performance.</p>
<p>  不想牺牲太多的吞吐量</p>
</li>
<li><p>Do not require a much larger Java heap.</p>
<p>  G1需要一个更大的堆空间，关键建议6G以上</p>
</li>
</ul>
<p>G1 is planned as the long term replacement for the Concurrent Mark-Sweep Collector (CMS). Comparing G1 with CMS, there are differences that make G1 a better solution. One difference is that G1 is a compacting collector. G1 compacts sufficiently to completely avoid the use of fine-grained free lists for allocation, and instead relies on regions. This considerably simplifies parts of the collector, and mostly eliminates potential fragmentation issues. Also, G1 offers more predictable garbage collection pauses than the CMS collector, and allows users to specify desired pause targets.</p>
<p>释义：G1使用并发和并行阶段实现其目标暂停时间，并保持良好的吞吐量,与CMS收集器不同的是，G1回收算法采取的并发-整理 ；它可以解决传统的parNew+CMS垃圾收集算法中,有很多晋代失败(promotion failed)/并发失败(concurrent mode failure),然后做Full gc的问题；G1提供更可预测的垃圾收集停顿比CMS收集器，并允许用户指定所需的停顿的目标。</p>
<blockquote>
<p>相关解释：</p>
</blockquote>
<p>G1收集器之所以能建立可预测的停顿时间模型，是因为他可以<strong>有计划的避免在整个java堆中进行全局与的垃圾收集</strong>。G1跟踪各个region里面垃圾堆积的价值大小(回收所获得的空间大小以及回收所需要时间的经验值)，在后台维护一个优先列表，每次根据允许收集时间，优先回收价值最大的region（这也就是Garbage-First名称的由来）</p>
<ul>
<li>并行和并发：适合并充分利用多CPU，多核环境</li>
<li>分代收集：分region去收集，可避免碎片化问题</li>
<li>空间整合：G1整体是基于Mark-compact 标记-整理，但是从局部 两个 region之间是基于”复制”算法实现</li>
<li>可预测停顿：建立可预测停顿时间，明确指定在一个长度为M毫秒的时间片内，消耗在垃圾收集上的时间不超过N毫秒</li>
</ul>
<h3 id="G1适合场景及特点"><a href="#G1适合场景及特点" class="headerlink" title="G1适合场景及特点"></a>G1适合场景及特点</h3><h4 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h4><ul>
<li>1)适用在big heap(6GB or larger)场景,不能容忍长时间停顿(Full GC)的服务器场景.</li>
<li>2)有大量存活对象(超过50%)的场景.例如:数据服务器场景.Hbase，Cassandra等.</li>
<li>3)解决传统的parNew+CMS垃圾收集算法中,有很多晋代失败(promotion failed)/并发失败(concurrent mode failure),然后做Full gc..</li>
</ul>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>1).G1可以控制最长停顿时间(-XX:MaxGCPauseMillis),这是个预计值,G1会根据这个时间制定回收策略,但是设置过低停顿回造成低吞吐。</li>
<li>2).G1基于复制的算法，回收过程不会产生碎片,这是相比CMS最大的优势.</li>
<li>3).G1把heap分割成很多大小相等的区域(region),不再使用固定空间分代的方式，采用逻辑分代:Eden,Survivor,Old。每个逻辑分代含有若干区域且数量可以动态调整.</li>
</ul>
<h4 id="查看分代情况"><a href="#查看分代情况" class="headerlink" title="查看分代情况"></a>查看分代情况</h4><pre><code>通过使用jmap -heap 得到的堆统计信息可以更好的理解逻辑分代:

    Heap Configuration:
       MinHeapFreeRatio = 40
       MaxHeapFreeRatio = 70
       MaxHeapSize      = 25769803776 (24576.0MB)
       NewSize          = 1363144 (1.2999954223632812MB)
       MaxNewSize       = 17592186044415 MB
       OldSize          = 5452592 (5.1999969482421875MB)
       NewRatio         = 2
       SurvivorRatio    = 6
       PermSize         = 100663296 (96.0MB)
       MaxPermSize      = 100663296 (96.0MB)
       G1HeapRegionSize = 8388608 (8.0MB)
    G1 Heap:
       regions  = 3072
       capacity = 25769803776 (24576.0MB)
       used     = 11232244096 (10711.902709960938MB)
       free     = 14537559680 (13864.097290039062MB)
       43.58684370915095% used
    G1 Young Generation:
    Eden Space:
       regions  = 29
       capacity = 1233125376 (1176.0MB)
       used     = 243269632 (232.0MB)
       free     = 989855744 (944.0MB)
       19.727891156462587% used
    Survivor Space:
       regions  = 14
       capacity = 117440512 (112.0MB)
       used     = 117440512 (112.0MB)
       free     = 0 (0.0MB)
       100.0% used
    G1 Old Generation:
       regions  = 1298
       capacity = 24419237888 (23288.0MB)
       used     = 10871533952 (10367.902709960938MB)
       free     = 13547703936 (12920.097290039062MB)
       44.52036546702567% used
</code></pre><h3 id="G1回收过程"><a href="#G1回收过程" class="headerlink" title="G1回收过程"></a>G1回收过程</h3><h4 id="G1-Heap-Structure"><a href="#G1-Heap-Structure" class="headerlink" title="G1 Heap Structure"></a>G1 Heap Structure</h4><ul>
<li>1). G1 Heap Structure<br><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide8.png" alt=""></li>
</ul>
<p>Region size is chosen by the JVM at startup. The JVM generally targets around 2000 regions varying in size from 1 to 32Mb.</p>
<p>G1 GC 启动后把堆被划分成大小相同的多个区域(Region)。区域的大小由(-XX:G1HeapRegionSize)指定,不指定区域大小会从1MB到32MB自动制定,区域大小确定后不会做动态调整.</p>
<ul>
<li><p>2). G1 Heap Allacation<br><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide9.png" alt=""><br>The heap is partitioned into a set of equal-sized heap regions, each a contiguous range of virtual memory. Certain region sets are assigned the same roles (eden, survivor, old) as in the older collectors, but there is not a fixed size for them. This provides greater flexibility in memory usage.</p>
<p>  整个heap划分为Eden,Survivor,Old三个不连续的逻辑区域。<br>运行过程中,G1会为每个Region使用Remembered Set来维护对象引用,<br>应用程序在对Reference类型的数据进行写操作时会产生一个Write Barrier暂时中断写操作，<br>检查Reference引用的对象是否处于不同的Region之中，如果是，便通过CardTable把相关引用信息记录到被引用对象所属的Region的Remembered Set之中。<br>当进行内存回收时，在GC根节点的枚举范围中加入Remembered Set来避免对全堆扫描.</p>
</li>
</ul>
<h4 id="几个概念"><a href="#几个概念" class="headerlink" title="几个概念"></a>几个概念</h4><p>G1 Footprint:<br>If you migrate from the ParallelOldGC or CMS collector to G1, you will likely see a larger JVM process size. This is largely related to “accounting” data structures such as Remembered Sets and Collection Sets.</p>
<ul>
<li><p><strong>Remembered Sets</strong>：or RSets track object references into a given region. There is one RSet per region in the heap. The RSet enables the parallel and independent collection of a region. <em>The overall footprint impact of RSets is less than 5%.</em></p>
</li>
<li><p><strong>Collection Sets</strong>:or CSets the set of regions that will be collected in a GC. All live data in a CSet is evacuated (copied/moved) during a GC. Sets of regions can be Eden, survivor, and/or old generation.<em> CSets have a less than 1% impact on the size of the JVM</em></p>
</li>
</ul>
<h4 id="G1收集过程"><a href="#G1收集过程" class="headerlink" title="G1收集过程"></a>G1收集过程</h4><p><img src="http://i3.itc.cn/20160904/aac_cc6377ea_e867_65d5_f0e4_03b27c6f52be_1.jpg" alt=""></p>
<ul>
<li>初始标记(inital Marking)</li>
<li>并发标记(Concurrent Marking)</li>
<li>最终标记(Final Marking)</li>
<li>筛选回收(live Data counting and Evacuation）</li>
</ul>
<p><img src="http://i2.itc.cn/20160904/aac_3d000bc6_44db_e229_78cd_6cde550ccd66_1.png" alt=""></p>
<p>回收过程按回收区域集合(CollectionSets/CSets)划分.CSets可以包含(Eden,survivor/old)中的region,CSets占用内存一般小于整个jvm的1%;<br>年轻代垃圾回收:<br>G1 Young GC同时回收eden区域和上次垃圾回收的存活区域。Eden 和survivor的存活对象被疏散(复制/移动)到新的区域集。<br>被疏散对象的目标区域取决于对象的年龄,达到晋升年龄的对象疏散到老年代区域,<br>否则疏散到存活区,并将它包含在下一次年轻代或混合垃圾回收的CSet中。<br>混合垃圾回收:<br>G1 Mixd GC同时回收Eden,survivor,old的存活区域。当成功完成并发标记周期后，G1 GC从执行年轻代垃圾回收切换为执行混合垃圾回收。<br>在混合垃圾回收期间,G1GC 将一些旧的区域添加到 eden 和存活区供将来回收。G1GC 回收了足够的旧区域后（经过多次混合垃圾回收），<br>G1将恢复执行年轻代垃圾回收,直到下一次标记周期完成。</p>
<h4 id="G1-YoungGC"><a href="#G1-YoungGC" class="headerlink" title="G1 YoungGC"></a>G1 YoungGC</h4><ul>
<li>1.The heap is split into approximately 2000 regions. Minimum size is 1Mb and maximum size is 32Mb. Blue regions hold old generation objects and green regions hold young generation objects.</li>
</ul>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide10.png" alt=""></p>
<ul>
<li>2.Live objects are evacuated (i.e., copied or moved) to one or more survivor regions. If the aging threshold is met, some of the objects are promoted to old generation regions.</li>
</ul>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide11.png" alt=""><br>This is a stop the world (STW) pause. Eden size and survivor size is calculated for the next young GC. Accounting information is kept to help calculate the size. Things like the pause time goal are taken into consideration.<br>This approach makes it very easy to resize regions, making them bigger or smaller as needed.</p>
<ul>
<li>3.End of a Young GC with G1,Live objects have been evacuated to survivor regions or to old generation regions.</li>
</ul>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide12.png" alt=""></p>
<p>Recently promoted objects are shown in dark blue. Survivor regions in green.<br>In summary, the following can be said about the young generation in G1:</p>
<ul>
<li>The heap is a single memory space split into regions.</li>
<li>Young generation memory is composed of a set of non-contiguous regions. This makes it easy to resize when needed.</li>
<li>Young generation garbage collections, or young GCs, are stop the world events. All application threads are stopped for the operation.</li>
<li>The young GC is done in parallel using multiple threads.</li>
<li>Live objects are copied to new survivor or old generation regions.</li>
</ul>
<h4 id="G1-OldGc"><a href="#G1-OldGc" class="headerlink" title="G1 OldGc"></a>G1 OldGc</h4><ul>
<li><ol>
<li><strong>Initial Marking Phase:</strong>Initial marking of live object is piggybacked on a young generation garbage collection. In the logs this is noted as GC pause (young)(inital-mark).</li>
</ol>
</li>
</ul>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide13.png" alt=""></p>
<ul>
<li>2.<strong>Concurrent Marking Phase:</strong>If empty regions are found (as denoted by the “X”), they are removed immediately in the Remark phase. Also, “accounting” information that determines liveness is calculated.</li>
</ul>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide14.png" alt=""></p>
<ul>
<li>3.<strong>Remark Phase:</strong>Empty regions are removed and reclaimed. Region liveness is now calculated for all regions.</li>
</ul>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide15.png" alt=""></p>
<ul>
<li><p>4.<strong> Copying/Cleanup Phase:</strong>G1 selects the regions with the lowest “liveness”, those regions which can be collected the fastest. Then those regions are collected at the same time as a young GC. This is denoted in the logs as [GC pause (mixed)]. So both young and old generations are collected at the same time.</p>
</li>
<li><p>5.<strong>After Copying/Cleanup Phase:</strong>The regions selected have been collected and compacted into the dark blue region and the dark green region shown in the diagram.</p>
</li>
</ul>
<p><img src="http://www.oracle.com/webfolder/technetwork/tutorials/obe/java/G1GettingStarted/images/slide17.png" alt=""></p>
<ul>
<li><p>6.<strong>Summary of Old Generation GC：</strong></p>
<p>  In summary, there are a few key points we can make about the G1 garbage collection on the old generation：</p>
<p>  <strong>Concurrent Marking Phase</strong></p>
<ul>
<li>Liveness information is calculated concurrently while the application is running.</li>
<li>This liveness information identifies which regions will be best to reclaim during an evacuation pause.</li>
<li><p>There is no sweeping phase like in CMS.</p>
<p><strong>Remark Phase</strong></p>
</li>
<li>Uses the Snapshot-at-the-Beginning (SATB) algorithm which is much faster then what was used with CMS.</li>
<li><p>Completely empty regions are reclaimed.</p>
<p><strong>Copying/Cleanup</strong> </p>
</li>
<li><p>PhaseYoung generation and old generation are reclaimed at the same time.</p>
</li>
<li>Old generation regions are selected based on their liveness.</li>
</ul>
</li>
</ul>
<h3 id="G1相关参数"><a href="#G1相关参数" class="headerlink" title="G1相关参数"></a>G1相关参数</h3><p>-XX:G1HeapRegionSize=n</p>
<pre><code>设置的 G1 区域的大小。值是 2 的幂，范围是 1 MB 到 32 MB 之间。目标是根据最小的 
Java 堆大小划分出约 2048 个区域。
</code></pre><p>-XX:MaxGCPauseMillis=200</p>
<pre><code>为所需的最长暂停时间设置目标值。默认值是 200 毫秒。指定的值不适用于您的堆大小。
</code></pre><p>-XX:ParallelGCThreads=cpus</p>
<pre><code>设置年轻代垃圾回收(STW)工作线程数的值。将 n 的值设置为逻辑处理器的数量。n 的值
与逻辑处理器的数量相同,G1根据cpu数量设置不同的初始值。
</code></pre><p>-XX:ConcGCThreads=cpus/4</p>
<pre><code>设置并发标记的线程数。将n设置为并行垃圾回收线程数 (ParallelGCThreads) 的 1/4 左右。
</code></pre><p>-XX:InitiatingHeapOccupancyPercent=45</p>
<pre><code>设置触发标记周期的Java堆占用率阈值。默认占用率是整个 Java 堆的 45%。
</code></pre><p>-XX:G1HeapWastePercent=10</p>
<pre><code>设置G1愿意浪费的堆百分比。如果可回收百分比小于堆废物百分比。默认值是 10%。
</code></pre><p>-XX:G1MixedGCCountTarget=8</p>
<pre><code>设置标记周期完成后，对旧区域执行混合垃圾回收的目标次数。默认值是 8 次混合垃圾回收。
混合回收的目标是控制在此目标次数以内。
</code></pre><p>-XX:G1ReservePercent=10</p>
<pre><code>设置作为空闲空间的预留内存百分比，以降低目标空间溢出的风险。默认值是 10%。增加或
减少百分比时,需要评估Java堆的量。
</code></pre><h3 id="G1优化建议"><a href="#G1优化建议" class="headerlink" title="G1优化建议"></a>G1优化建议</h3><ul>
<li><p>1:不要使用-Xmn/-XX:NewRatio等设置年轻代大小,G1使用逻辑分代,年轻代大小是动态调整的.且固定年轻代的大小会覆盖暂停时间目标</p>
</li>
<li><p>2:暂停时间目标(-XX:MaxGCPauseMillis):设置所需的软实时目标，G1GC 会尽量满足.当对垃圾回收进行评估或调优时,都会涉及到延迟与吞吐量的取舍。需要G1高吞吐量时,暂停时间目标不要太严苛。</p>
</li>
<li><p>3:调优混合垃圾回收时，需合理调整以下参数:<br>-XX:InitiatingHeapOccupancyPercent 用于更改标记阈值。更小的值意味着更快的触发标记周期。<br>-XX:G1MixedGCCountTarget 用于调整Old区域的CSet集合。</p>
</li>
<li><p>4:G1溢出/耗尽引发的FullGc<br>2014-03-06T10:01:28.216+0800: 67998.279: [GC pause (mixed) (to-space exhausted), 13.8681600 secs]<br>2014-03-04T10:01:42.086+0800: 68012.149: [GC pause (mixed) (to-space overflow), 3.0012670 secs]<br>优化参数:<br>增加-XX:G1ReservePercent 选项的值（并相应增加总的堆大小,为”目标空间”预留更多内存空间。<br>减少 -XX:InitiatingHeapOccupancyPercent 提前启动标记周期。<br>增加 -XX:ConcGCThreads 选项的值来增加并行标记线程的数目,加快标记速度。</p>
</li>
<li><p>5:避免巨型对象<br>G1对于任何超过区域一半大小的对象都被视为“巨型对象”,巨型区域直接被分配到老年代中.<br>巨型区域是一个连续的区域集。StartsHumongous 标记该连续集的开始，ContinuesHumongous 标记它的延续.<br>所以没有使用的巨型对象的终点与上个区域的终点之间的空间无法被使用,<br>如果对象只是略大于堆区域大小的倍数，未使用的空间可能会导致堆碎片化。<br>巨型对象也可能分配导致连续的并发周期，并且此类分配导致老年代碎片化<br>通过增加-XX:G1HeapRegionSize的值,提高巨型对象的门槛(G1HeapRegionSize/2)。</p>
</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>G1日志分析参考：<a href="https://blogs.oracle.com/poonam/entry/understanding_g1_gc_logs" target="_blank" rel="external">https://blogs.oracle.com/poonam/entry/understanding_g1_gc_logs</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/metor.ico"
               alt="Pedestrian" />
          <p class="site-author-name" itemprop="name">Pedestrian</p>
          <p class="site-description motion-element" itemprop="description">study for goal</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">60</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">40</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">59</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yanan0628" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://carlosfu.github.io/" target="_blank" title="fudada">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  fudada
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://jolinzhangg.github.io/" target="_blank" title="xiaodada">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  xiaodada
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pedestrian</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
