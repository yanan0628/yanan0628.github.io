<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="rpc," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="dubbo架构原理 框架设计   config，配置层，对外配置接口，以ServiceConfig, ReferenceConfig为中心，可以直接new配置类，也可以通过spring解析配置生成配置类 proxy，服务代理层，服务接口透明代理，生成服务的客户端Stub和服务器端Skeleton，以ServiceProxy为中心，扩展接口为ProxyFactory registry，注册中心层，封">
<meta name="keywords" content="rpc">
<meta property="og:type" content="article">
<meta property="og:title" content="dubbo架构和源码分析">
<meta property="og:url" content="/2016/07/01/(7.1).分布式架构-dubbo/index.html">
<meta property="og:site_name" content="Meteor">
<meta property="og:description" content="dubbo架构原理 框架设计   config，配置层，对外配置接口，以ServiceConfig, ReferenceConfig为中心，可以直接new配置类，也可以通过spring解析配置生成配置类 proxy，服务代理层，服务接口透明代理，生成服务的客户端Stub和服务器端Skeleton，以ServiceProxy为中心，扩展接口为ProxyFactory registry，注册中心层，封">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://i2.itc.cn/20160517/aac_f5d59df3_6197_4d8e_0bd9_908362449c02_2.png">
<meta property="og:image" content="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_4.jpg">
<meta property="og:image" content="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_5.jpg">
<meta property="og:image" content="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_1.jpg">
<meta property="og:image" content="http://i0.itc.cn/20160517/aac_a79a5d67_e696_226f_8b20_43823e592833_2.jpg">
<meta property="og:image" content="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_3.jpg">
<meta property="og:image" content="http://i1.itc.cn/20160517/aac_a79a5d67_e696_226f_8b20_43823e592833_1.jpg">
<meta property="og:image" content="http://i1.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_2.jpg">
<meta property="og:image" content="http://i0.itc.cn/20160517/aac_ded2c05b_fd56_b12c_50e9_c061de9e1974_1.jpg">
<meta property="og:image" content="http://i3.itc.cn/20160517/aac_ded2c05b_fd56_b12c_50e9_c061de9e1974_2.jpg">
<meta property="og:image" content="http://i0.itc.cn/20160519/aac_a513baa8_9587_2b34_456c_29f80c21d359_2.jpg">
<meta property="og:updated_time" content="2016-07-08T01:42:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dubbo架构和源码分析">
<meta name="twitter:description" content="dubbo架构原理 框架设计   config，配置层，对外配置接口，以ServiceConfig, ReferenceConfig为中心，可以直接new配置类，也可以通过spring解析配置生成配置类 proxy，服务代理层，服务接口透明代理，生成服务的客户端Stub和服务器端Skeleton，以ServiceProxy为中心，扩展接口为ProxyFactory registry，注册中心层，封">
<meta name="twitter:image" content="http://i2.itc.cn/20160517/aac_f5d59df3_6197_4d8e_0bd9_908362449c02_2.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> dubbo架构和源码分析 | Meteor </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Meteor</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                dubbo架构和源码分析
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-01T10:52:03+08:00" content="2016-07-01">
              2016-07-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="dubbo架构原理"><a href="#dubbo架构原理" class="headerlink" title="dubbo架构原理"></a>dubbo架构原理</h2><blockquote>
<h3 id="框架设计"><a href="#框架设计" class="headerlink" title="框架设计"></a>框架设计</h3></blockquote>
<p><img src="http://i2.itc.cn/20160517/aac_f5d59df3_6197_4d8e_0bd9_908362449c02_2.png" alt="dubbo框架结构"></p>
<ul>
<li><code>config，配置层</code>，对外配置接口，以ServiceConfig, ReferenceConfig为中心，可以直接new配置类，也可以通过spring解析配置生成配置类</li>
<li><code>proxy，服务代理层</code>，服务接口透明代理，生成服务的客户端Stub和服务器端Skeleton，以ServiceProxy为中心，扩展接口为ProxyFactory</li>
<li><code>registry，注册中心层</code>，封装服务地址的注册与发现，以服务URL为中心，扩展接口为RegistryFactory, Registry, RegistryService</li>
<li><code>cluster，路由层</code>，封装多个提供者的路由及负载均衡，并桥接注册中心，以Invoker为中心，扩展接口为Cluster, Directory, Router, LoadBalance</li>
<li><code>monitor，监控层</code>，RPC调用次数和调用时间监控，以Statistics为中心，扩展接口为MonitorFactory, Monitor, MonitorService</li>
<li><code>protocol，远程调用层</code>，封将RPC调用，以Invocation, Result为中心，扩展接口为Protocol, Invoker, Exporter</li>
<li><code>exchange，信息交换层</code>，封装请求响应模式，同步转异步，以Request, Response为中心，扩展接口为Exchanger, ExchangeChannel, ExchangeClient, ExchangeServer</li>
<li><code>transport，网络传输层</code>，抽象mina和netty为统一接口，以Message为中心，扩展接口为Channel, Transporter, Client, Server, Codec</li>
<li><code>serialize，数据序列化层</code>，可复用的一些工具，扩展接口为Serialization, ObjectInput, ObjectOutput, ThreadPool</li>
</ul>
<blockquote>
<h3 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h3></blockquote>
<p><img src="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_4.jpg" alt="dubbo服务端和客户端调用关系"></p>
<p><strong>节点角色说明：</strong></p>
<ul>
<li>Provider: 暴露服务的服务提供方。</li>
<li>Consumer: 调用远程服务的服务消费方。</li>
<li>Registry: 服务注册与发现的注册中心。</li>
<li>Monitor: 统计服务的调用次调和调用时间的监控中心。</li>
<li>Container: 服务运行容器。</li>
</ul>
<p><strong>调用关系说明：</strong></p>
<ul>
<li>0-服务容器负责启动，加载，运行服务提供者。</li>
<li>1-服务提供者在启动时，向注册中心注册自己提供的服务。</li>
<li>2-服务消费者在启动时，向注册中心订阅自己所需的服务。</li>
<li>3-注册中心返回服务提供者地址列表给消费者，如果有变更，注册中心将基于长连接推送变更数据给消费者。</li>
<li>4-服务消费者，从提供者地址列表中，基于软负载均衡算法，选一台提供者进行调用，如果调用失败，再选另一台调用。</li>
<li>5-服务消费者和提供者，在内存中累计调用次数和调用时间，定时每分钟发送一次统计数据到监控中心。</li>
</ul>
<a id="more"></a>
<p><strong>dubbo架构重要特性：</strong></p>
<p>(1) <code>连通性</code>：</p>
<ul>
<li>注册中心负责服务地址的注册与查找，相当于目录服务，服务提供者和消费者只在启动时与注册中心交互，注册中心不转发请求，压力较小</li>
<li>监控中心负责统计各服务调用次数，调用时间等，统计先在内存汇总后每分钟一次发送到监控中心服务器，并以报表展示</li>
<li>服务提供者向注册中心注册其提供的服务，并汇报调用时间到监控中心，此时间不包含网络开销</li>
<li>服务消费者向注册中心获取服务提供者地址列表，并根据负载算法直接调用提供者，同时汇报调用时间到监控中心，此时间包含网络开销</li>
<li>注册中心，服务提供者，服务消费者三者之间均为长连接，监控中心除外</li>
<li>注册中心通过长连接感知服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者</li>
<li>注册中心和监控中心全部宕机，不影响已运行的提供者和消费者，消费者在本地缓存了提供者列表</li>
<li>注册中心和监控中心都是可选的，服务消费者可以直连服务提供者</li>
</ul>
<p>(2) <code>健状性</code>：</p>
<ul>
<li>监控中心宕掉不影响使用，只是丢失部分采样数据</li>
<li>数据库宕掉后，注册中心仍能通过缓存提供服务列表查询，但不能注册新服务</li>
<li>注册中心对等集群，任意一台宕掉后，将自动切换到另一台</li>
<li>注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通讯</li>
<li>服务提供者无状态，任意一台宕掉后，不影响使用</li>
<li>服务提供者全部宕掉后，服务消费者应用将无法使用，并无限次重连等待服务提供者恢复</li>
</ul>
<p>(3) <code>伸缩性</code>：</p>
<ul>
<li>注册中心为对等集群，可动态增加机器部署实例，所有客户端将自动发现新的注册中心</li>
<li>服务提供者无状态，可动态增加机器部署实例，注册中心将推送新的服务提供者信息给消费者</li>
</ul>
<p>(4) <code>扩展性</code></p>
<ul>
<li>支持spi扩展点，可动态扩展</li>
<li>可配置filter，做请求扩展处理</li>
</ul>
<blockquote>
<h3 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h3></blockquote>
<p><img src="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_5.jpg" alt="服务端和客户端调用"></p>
<h2 id="dubbo使用原理"><a href="#dubbo使用原理" class="headerlink" title="dubbo使用原理"></a>dubbo使用原理</h2><blockquote>
<h3 id="源码接入方式"><a href="#源码接入方式" class="headerlink" title="源码接入方式"></a>源码接入方式</h3></blockquote>
<p><strong>git接入项目:</strong></p>
<pre><code>git clone https://github.com/alibaba/dubbo dubbo
</code></pre><p><strong>maven编译项目：</strong></p>
<pre><code>maven命令：maven:mvn install -Dmaven.test.skip
设置JVM参数：set MAVEN_OPTS=-Xmx1024m -XX:MaxPermSize=512m
</code></pre><p><strong>dubbo模块划分：</strong></p>
<p><img src="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_1.jpg" alt="dubbo模块依赖"></p>
<p>模块说明:</p>
<ul>
<li>dubbo-common:公共逻辑模块</li>
<li>dubbo-remoting:远程通讯模块，基于dubbo协议实现</li>
<li>dubbo-rpc:远程调用模块，抽象各层协议以及动态代理，只包含一对一调用，不关心</li>
<li>管理。</li>
<li>dubbo-cluster:</li>
<li>模块，将多个服务方伪装成一个提供方，包括：负载均衡，容错，路由，集群地址列表等等</li>
<li>dubbo-registry:注册中心模块，基于注册中心下发地址的集群方式，以及对各注册中心抽象</li>
<li>dubbo-monitor:监控模块，统计服务/客户端调用次数，调用时间，调用链跟踪服务</li>
<li>dubbo-config:dubbo配置模块，是dubbo对外提供的api,用户通过config配置隐藏dubbo所有细节</li>
<li><p>dubbo-container:容器模块，是一个standalone容器，以简单的Main加载Spring启动，不依赖tomcat/Jboss等容器</p>
<p>   container为服务容器，用于部署运行服务，没有在层中画出。<br>   protocol层和proxy层都放在rpc模块中，这两层是rpc的核心，在不需要集群时</p>
<pre><code>(只有一个提供者)，可以只使用这两层完成rpc调用。
</code></pre><p>   transport层和exchange层都放在remoting模块中，为rpc调用的通讯基础。<br>   serialize层放在common模块中，以便更大程度复用。</p>
</li>
</ul>
<blockquote>
<h3 id="基于扩展点SPI支持"><a href="#基于扩展点SPI支持" class="headerlink" title="基于扩展点SPI支持"></a>基于扩展点SPI支持</h3></blockquote>
<h4 id="SPI规范"><a href="#SPI规范" class="headerlink" title="SPI规范"></a>SPI规范</h4><pre><code>来源：Dubbo的扩展点加载从JDK标准的SPI(Service Provider Interface)扩展点发现机制加
     强而来。这里的配置文件是放在你自己的jar包内，不是dubbo本身的jar包内，Dubbo会全
     ClassPath扫描所有jar包内同名的这个文件，然后进行合并。

约定：在扩展类的jar包内，放置扩展点配置文件：META-INF/dubbo/接口全限定名，内容为：
      配置名=扩展实现类全限定名，多个实现类用换行符分隔。
</code></pre><h4 id="spi实现方式"><a href="#spi实现方式" class="headerlink" title="spi实现方式"></a>spi实现方式</h4><ul>
<li>1.dubbo相应接口需要通过@spi标签注解标识，dubbo已有实现和自己实现需要保证线程安全</li>
<li>2.扩展点使用单一实例加载（请确保扩展实现的线程安全性），Cache在ExtensionLoader中。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 扩展点接口的标识。</span></div><div class="line"><span class="comment"> * &lt;p /&gt;</span></div><div class="line"><span class="comment"> * 扩展点声明配置文件，格式修改。&lt;br /&gt;</span></div><div class="line"><span class="comment"> * 以Protocol示例，配置文件META-INF/dubbo/com.xxx.Protocol内容：&lt;br /&gt;</span></div><div class="line"><span class="comment"> * 由&lt;br/&gt;</span></div><div class="line"><span class="comment"> * &lt;pre&gt;&lt;code&gt;com.foo.XxxProtocol</span></div><div class="line"><span class="comment">com.foo.YyyProtocol&lt;/code&gt;&lt;/pre&gt;&lt;br/&gt;</span></div><div class="line"><span class="comment"> * 改成使用KV格式&lt;br/&gt;</span></div><div class="line"><span class="comment"> * &lt;pre&gt;&lt;code&gt;xxx=com.foo.XxxProtocol</span></div><div class="line"><span class="comment">yyy=com.foo.YyyProtocol</span></div><div class="line"><span class="comment"> * &lt;/code&gt;&lt;/pre&gt;</span></div><div class="line"><span class="comment"> * &lt;br/&gt;</span></div><div class="line"><span class="comment"> * 原因：&lt;br/&gt;</span></div><div class="line"><span class="comment"> * 当扩展点的static字段或方法签名上引用了三方库，</span></div><div class="line"><span class="comment"> * 如果三方库不存在，会导致类初始化失败，</span></div><div class="line"><span class="comment"> * Extension标识Dubbo就拿不到了，异常信息就和配置对应不起来。</span></div><div class="line"><span class="comment"> * &lt;br/&gt;</span></div><div class="line"><span class="comment"> * 比如:</span></div><div class="line"><span class="comment"> * Extension("mina")加载失败，</span></div><div class="line"><span class="comment"> * 当用户配置使用mina时，就会报找不到扩展点，</span></div><div class="line"><span class="comment"> * 而不是报加载扩展点失败，以及失败原因。</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> william.liangf</span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> ding.lid</span></div><div class="line"><span class="comment"> * <span class="doctag">@export</span></span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SPI &#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 缺省扩展点名。</span></div><div class="line"><span class="comment">     */</span></div><div class="line">	<span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Dubbo使用的扩展点获取。&lt;p&gt;</span></div><div class="line"><span class="comment"> * &lt;ul&gt;</span></div><div class="line"><span class="comment"> * &lt;li&gt;自动注入关联扩展点。&lt;/li&gt;</span></div><div class="line"><span class="comment"> * &lt;li&gt;自动Wrap上扩展点的Wrap类。&lt;/li&gt;</span></div><div class="line"><span class="comment"> * &lt;li&gt;缺省获得的的扩展点是一个Adaptive Instance。</span></div><div class="line"><span class="comment"> * &lt;/ul&gt;</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> &lt;a href="http://java.sun.com/j2se/1.5.0/docs/guide/jar/jar.html#Service%20Provider"&gt;JDK5.0的自动发现机制实现&lt;/a&gt;</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> com.alibaba.dubbo.common.extension.SPI</span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> com.alibaba.dubbo.common.extension.Adaptive</span></div><div class="line"><span class="comment"> * <span class="doctag">@see</span> com.alibaba.dubbo.common.extension.Activate</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtensionLoader</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">   	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICES_DIRECTORY = <span class="string">"META-INF/services/"</span>;</div><div class="line"></div><div class="line">   	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_DIRECTORY = <span class="string">"META-INF/dubbo/"</span>;</div><div class="line">   </div><div class="line">   	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + <span class="string">"internal/"</span>;</div><div class="line"></div><div class="line">	......</div><div class="line">	<span class="comment">//注入点实现</span></div><div class="line">	<span class="function"><span class="keyword">private</span> T <span class="title">injectExtension</span><span class="params">(T instance)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (objectFactory != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (Method method : instance.getClass().getMethods()) &#123;</div><div class="line">                    <span class="keyword">if</span> (method.getName().startsWith(<span class="string">"set"</span>)</div><div class="line">                            &amp;&amp; method.getParameterTypes().length == <span class="number">1</span></div><div class="line">                            &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</div><div class="line">                        Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            String property = method.getName().length() &gt; <span class="number">3</span> ? method.getName().substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + method.getName().substring(<span class="number">4</span>) : <span class="string">""</span>;</div><div class="line">                            <span class="comment">//获取属性 set的对象名称</span></div><div class="line">                            Object object = objectFactory.getExtension(pt, property);</div><div class="line">                            <span class="keyword">if</span> (object != <span class="keyword">null</span>) &#123;</div><div class="line">                            	<span class="comment">//初始化setter操作</span></div><div class="line">                                method.invoke(instance, object);</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                            logger.error(<span class="string">"fail to inject via method "</span> + method.getName()</div><div class="line">                                    + <span class="string">" of interface "</span> + type.getName() + <span class="string">": "</span> + e.getMessage(), e);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            logger.error(e.getMessage(), e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">	......</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>==ExtensionLoader详细源码实现==：<a href="http://blog.csdn.net/jdluojing/article/details/44947221" target="_blank" rel="external">扩展点加载机制(ExtensionLoader) </a></p>
<h4 id="项目使用spi配置"><a href="#项目使用spi配置" class="headerlink" title="项目使用spi配置"></a>项目使用spi配置</h4><p>Dubbo中Protocol,Filter等接口，@SPI加入注解标签，可以实现自己的扩展接口。</p>
<ul>
<li><p>1.dubbo中添加filter，可以直接在项目配置基于filter扩展点</p>
<pre><code>authority=com.sohu.tv.rank.vrs.filter.AuthorityFilter
</code></pre></li>
<li><p>2.dubbo默认启动spring contanier容器,可以通过配置Main来启动</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">	</div><div class="line">public static void main(String[] args) throws InterruptedException &#123;  </div><div class="line">	//启动container容器</div><div class="line">	com.alibaba.dubbo.container.Main.main(args);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//1.添加spring默认加载路径，将配置文件放在默认目录下</div><div class="line">	classpath*:META-INF/spring/*.xml</div><div class="line">//2.指定spring加载路径，添加dubbo.properties文件，并配置相关属性</div><div class="line">	dubbo.spring.config=classpath*:**(相对路径下)</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<h3 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h3><h4 id="解析服务"><a href="#解析服务" class="headerlink" title="解析服务"></a>解析服务</h4></blockquote>
<ul>
<li><p>基于dubbo.jar内的META-INF/spring.handlers配置，Spring在遇到dubbo名称空间时，会回调DubboNamespaceHandler。</p>
</li>
<li><p>所有dubbo的标签，都统一用DubboBeanDefinitionParser进行解析，基于一对一属性映射，<code>将XML标签解析为Bean对象</code>。</p>
</li>
<li><p>在<code>ServiceConfig.export()</code>或<code>ReferenceConfig.get()</code>初始化时，将Bean对象转换URL格式，所有Bean属性转成URL的参数。</p>
</li>
<li><p>然后将<code>URL传给Protocol扩展点</code>，基于扩展点的Adaptive机制，根据URL的协议头，进行不同协议的服务暴露或引用。</p>
</li>
</ul>
<h4 id="暴露服务"><a href="#暴露服务" class="headerlink" title="暴露服务"></a>暴露服务</h4><p><img src="http://i0.itc.cn/20160517/aac_a79a5d67_e696_226f_8b20_43823e592833_2.jpg" alt="服务端暴露"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">1</span>.通过服务端serviceConfig暴露，将url,<span class="class"><span class="keyword">class</span>信息转换为<span class="title">Invoker</span></span></div><div class="line"><span class="class">2.通过对应***<span class="title">Protocol</span>协议对<span class="title">invoker</span>暴露到注册中心(订阅-注册)</span></div><div class="line"><span class="class"></span></div><div class="line"><span class="class">//准备注册服务端<span class="title">service</span></span></div><div class="line"><span class="class"><span class="title">if</span> (<span class="title">logger</span>.<span class="title">isInfoEnabled</span>()) </span>&#123;</div><div class="line">    logger.info(<span class="string">"Register dubbo service "</span> + interfaceClass.getName() + <span class="string">" url "</span> + url + <span class="string">" to registry "</span> + registryURL);</div><div class="line">&#125;</div><div class="line"><span class="comment">//proxy动态代理生成字节码  jdkProxyFactory/javassistProxyFactory</span></div><div class="line">Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));</div><div class="line"><span class="comment">//暴露</span></div><div class="line">Exporter&lt;?&gt; exporter = protocol.export(invoker);</div><div class="line">exporters.add(exporter);</div></pre></td></tr></table></figure>
<p>时序图：<br><img src="http://i3.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_3.jpg" alt="服务端调用时序图"></p>
<h4 id="引用服务"><a href="#引用服务" class="headerlink" title="引用服务"></a>引用服务</h4><p><img src="http://i1.itc.cn/20160517/aac_a79a5d67_e696_226f_8b20_43823e592833_1.jpg" alt="客户端通过invoker远程调用"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="number">1</span>.通过referenceConfig获取注册中心url, 用户指定URL，指定的URL可能是对点对直连地址，也可能是注册中心URL</div><div class="line">	<span class="number">2</span>.将url转换为invoker对象，准备进行远程调用</div><div class="line"></div><div class="line"><span class="keyword">if</span> (urls.size() == <span class="number">1</span>) &#123;</div><div class="line">       invoker = refprotocol.refer(interfaceClass, urls.get(<span class="number">0</span>));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">       List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;?&gt;&gt;();</div><div class="line">       URL registryURL = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">for</span> (URL url : urls) &#123;</div><div class="line">           invokers.add(refprotocol.refer(interfaceClass, url));</div><div class="line">           <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) &#123;</div><div class="line">               registryURL = url; <span class="comment">// 用了最后一个registry url</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (registryURL != <span class="keyword">null</span>) &#123; <span class="comment">// 有 注册中心协议的URL</span></div><div class="line">           <span class="comment">// 对有注册中心的Cluster 只用 AvailableCluster</span></div><div class="line">           URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME); </div><div class="line">           invoker = cluster.join(<span class="keyword">new</span> StaticDirectory(u, invokers));</div><div class="line">       &#125;  <span class="keyword">else</span> &#123; <span class="comment">// 不是 注册中心的URL</span></div><div class="line">           invoker = cluster.join(<span class="keyword">new</span> StaticDirectory(invokers));</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 创建服务代理 **</span></div><div class="line">   <span class="keyword">return</span> (T) proxyFactory.getProxy(invoker);</div></pre></td></tr></table></figure>
<p>时序图：<br><img src="http://i1.itc.cn/20160516/aac_ec527bd3_be4b_a20b_eb92_3020fcd4d4f7_2.jpg" alt="客户端调用时序图"></p>
<h4 id="通讯细节-IO-线程池"><a href="#通讯细节-IO-线程池" class="headerlink" title="通讯细节/IO,线程池"></a>通讯细节/IO,线程池</h4><blockquote>
<p>通讯协议约定(和序列化有关系)</p>
</blockquote>
<p><img src="http://i0.itc.cn/20160517/aac_ded2c05b_fd56_b12c_50e9_c061de9e1974_1.jpg" alt="通讯协议头约定"></p>
<blockquote>
<p>线程派发模型(类似NIO实现原理)</p>
</blockquote>
<p><img src="http://i3.itc.cn/20160517/aac_ded2c05b_fd56_b12c_50e9_c061de9e1974_2.jpg" alt="线程模型"></p>
<pre><code>Dispather
    all, direct, message, execution, connection
ThreadPool(可扩展实现 threadpoolexecutor)
    fixed, cached                
</code></pre><h4 id="集群相关"><a href="#集群相关" class="headerlink" title="集群相关"></a>集群相关</h4><blockquote>
<h5 id="集群调用模型图："><a href="#集群调用模型图：" class="headerlink" title="集群调用模型图："></a>集群调用模型图：</h5></blockquote>
<p><img src="http://i0.itc.cn/20160519/aac_a513baa8_9587_2b34_456c_29f80c21d359_2.jpg" alt="集群容错策略"></p>
<ul>
<li>这里的<code>Invoker</code>是<code>Provider的一个可调用Service的抽象</code>，Invoker封装了Provider地址及Service接口信息。</li>
<li><code>Directory</code>代表<code>多个Invoker</code>，可以把它看成List<invoker>，但与List不同的是，它的值可能是动态变化的，比如注册中心推送变更。</invoker></li>
<li>Cluster将Directory中的多个Invoker伪装成一个Invoker，对上层透明，伪装过程包含了容错逻辑，调用失败后，重试另一个。</li>
<li><code>Router</code>负责<code>从多个Invoker中按路由规则选出子集</code>，比如读写分离，应用隔离等。</li>
<li><code>LoadBalance</code>负责<code>从多个Invoker中选出具体的一个用于本次调用</code>，选的过程包含了负载均衡算法，调用失败后，需要重选。</li>
</ul>
<p>参考dubbo-cluster文章：<a href="http://blog.csdn.net/jnqqls/article/details/46702103" target="_blank" rel="external">dubbo集群容错和负载均衡策略</a></p>
<blockquote>
<h5 id="集群容错"><a href="#集群容错" class="headerlink" title="集群容错"></a>集群容错</h5></blockquote>
<p>在集群调用失败时，Dubbo提供了多种容错方案，缺省为failover重试。</p>
<ul>
<li><p><code>Failover Cluster</code>策略–『适合读操作』</p>
<pre><code>适合：失败自动切换，当出现失败，重试其它服务器。(缺省)通常用于读操作，
     但重试会带来更长延迟。可通过retries=&quot;2&quot;来设置重试次数(不含第一次)。
可能存在问题：如果针对高并发 高QPS系统，使用重试需要注意，一旦服务有问题，很有可能
     造成流量翻倍。
</code></pre></li>
<li><p><code>Failfast Cluster</code>策略–『适合写操作』</p>
<pre><code>适合：快速失败，只发起一次调用，失败立即报错。通常用于非幂等性的写操作，
     比如新增记录。
理解：对于客户端对于写操作需要快速知道报错，并进行容错处理，提示失败或者
     响应操作。
</code></pre></li>
<li><p><code>Failsafe Cluster</code>策略</p>
<pre><code>适合：失败安全，出现异常时，直接忽略。通常用于写入审计日志等操作。
</code></pre></li>
<li><p><code>Failback Cluster</code>策略</p>
<pre><code>适合：失败自动恢复，后台记录失败请求，定时重发。通常用于消息通知操作。
理解：和MQ重试策略类似，会重试请求。
</code></pre></li>
<li><p><code>Forking Cluster</code>策略</p>
<pre><code>适合：并行调用多个服务器，只要一个成功即返回。通常用于实时性要求较高的读操作，但需          要浪费更多服务资源。可通过forks=&quot;2&quot;来设置最大并行数。
</code></pre></li>
<li><p><code>Broadcast Cluster</code>策略</p>
<pre><code>适合：广播调用所有提供者，逐个调用，任意一台报错则报错。(2.1.0开始支持)通常用于通         知所有提供者更新缓存或日志等本地资源信息。
理解：清除本地缓存，但是对所有provider都需要做轮训，一般是按照MQ消息订阅去刷本地    缓存
</code></pre></li>
</ul>
<blockquote>
<h5 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h5></blockquote>
<p>在集群负载均衡时，Dubbo提供了多种均衡策略，缺省为random随机调用.</p>
<blockquote>
<ul>
<li>基于<code>ConsistentHash LoadBalance</code>实现</li>
</ul>
</blockquote>
<ul>
<li>一致性Hash，相同参数的请求总是发到同一提供者。</li>
<li>当某一台提供者挂时，原本发往该提供者的请求，基于虚拟节点，平摊到其它提供者，不会引起剧烈变动。</li>
<li>缺省只对第一个参数Hash，如果要修改，请配置<dubbo:parameter key="hash.arguments" value="0,1"></dubbo:parameter></li>
<li>缺省用160份虚拟节点，如果要修改，请配置<dubbo:parameter key="hash.nodes" value="320"></dubbo:parameter></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * ConsistentHashLoadBalance</div><div class="line"> * </div><div class="line"> * @author william.liangf</div><div class="line"> */</div><div class="line">public class ConsistentHashLoadBalance extends AbstractLoadBalance &#123;</div><div class="line"></div><div class="line">    private final ConcurrentMap&lt;String, ConsistentHashSelector&lt;?&gt;&gt; selectors = new ConcurrentHashMap&lt;String, ConsistentHashSelector&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    @Override</div><div class="line">    protected &lt;T&gt; Invoker&lt;T&gt; doSelect(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) &#123;</div><div class="line">        String key = invokers.get(0).getUrl().getServiceKey() + &quot;.&quot; + invocation.getMethodName();</div><div class="line">        int identityHashCode = System.identityHashCode(invokers);</div><div class="line">        ConsistentHashSelector&lt;T&gt; selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);</div><div class="line">        if (selector == null || selector.getIdentityHashCode() != identityHashCode) &#123;</div><div class="line">            selectors.put(key, new ConsistentHashSelector&lt;T&gt;(invokers, invocation.getMethodName(), identityHashCode));</div><div class="line">            selector = (ConsistentHashSelector&lt;T&gt;) selectors.get(key);</div><div class="line">        &#125;</div><div class="line">        return selector.select(invocation);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static final class ConsistentHashSelector&lt;T&gt; &#123;</div><div class="line"></div><div class="line">        private final TreeMap&lt;Long, Invoker&lt;T&gt;&gt; virtualInvokers;</div><div class="line"></div><div class="line">        private final int                       replicaNumber;</div><div class="line">        </div><div class="line">        private final int                       identityHashCode;</div><div class="line">        </div><div class="line">        private final int[]                     argumentIndex;</div><div class="line"></div><div class="line">        public ConsistentHashSelector(List&lt;Invoker&lt;T&gt;&gt; invokers, String methodName, int identityHashCode) &#123;</div><div class="line">            this.virtualInvokers = new TreeMap&lt;Long, Invoker&lt;T&gt;&gt;();</div><div class="line">            this.identityHashCode = System.identityHashCode(invokers);</div><div class="line">            URL url = invokers.get(0).getUrl();</div><div class="line">            this.replicaNumber = url.getMethodParameter(methodName, &quot;hash.nodes&quot;, 160);</div><div class="line">            String[] index = Constants.COMMA_SPLIT_PATTERN.split(url.getMethodParameter(methodName, &quot;hash.arguments&quot;, &quot;0&quot;));</div><div class="line">            argumentIndex = new int[index.length];</div><div class="line">            for (int i = 0; i &lt; index.length; i ++) &#123;</div><div class="line">                argumentIndex[i] = Integer.parseInt(index[i]);</div><div class="line">            &#125;</div><div class="line">            for (Invoker&lt;T&gt; invoker : invokers) &#123;</div><div class="line">                for (int i = 0; i &lt; replicaNumber / 4; i++) &#123;</div><div class="line">                    byte[] digest = md5(invoker.getUrl().toFullString() + i);</div><div class="line">                    for (int h = 0; h &lt; 4; h++) &#123;</div><div class="line">                        long m = hash(digest, h);</div><div class="line">                        virtualInvokers.put(m, invoker);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public int getIdentityHashCode() &#123;</div><div class="line">            return identityHashCode;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public Invoker&lt;T&gt; select(Invocation invocation) &#123;</div><div class="line">            String key = toKey(invocation.getArguments());</div><div class="line">            byte[] digest = md5(key);</div><div class="line">            Invoker&lt;T&gt; invoker = sekectForKey(hash(digest, 0));</div><div class="line">            return invoker;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private String toKey(Object[] args) &#123;</div><div class="line">            StringBuilder buf = new StringBuilder();</div><div class="line">            for (int i : argumentIndex) &#123;</div><div class="line">                if (i &gt;= 0 &amp;&amp; i &lt; args.length) &#123;</div><div class="line">                    buf.append(args[i]);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return buf.toString();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private Invoker&lt;T&gt; sekectForKey(long hash) &#123;</div><div class="line">            Invoker&lt;T&gt; invoker;</div><div class="line">            Long key = hash;</div><div class="line">            if (!virtualInvokers.containsKey(key)) &#123;</div><div class="line">                SortedMap&lt;Long, Invoker&lt;T&gt;&gt; tailMap = virtualInvokers.tailMap(key);</div><div class="line">                if (tailMap.isEmpty()) &#123;</div><div class="line">                    key = virtualInvokers.firstKey();</div><div class="line">                &#125; else &#123;</div><div class="line">                    key = tailMap.firstKey();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            invoker = virtualInvokers.get(key);</div><div class="line">            return invoker;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private long hash(byte[] digest, int number) &#123;</div><div class="line">            return (((long) (digest[3 + number * 4] &amp; 0xFF) &lt;&lt; 24)</div><div class="line">                    | ((long) (digest[2 + number * 4] &amp; 0xFF) &lt;&lt; 16)</div><div class="line">                    | ((long) (digest[1 + number * 4] &amp; 0xFF) &lt;&lt; 8) </div><div class="line">                    | (digest[0 + number * 4] &amp; 0xFF)) </div><div class="line">                    &amp; 0xFFFFFFFFL;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        private byte[] md5(String value) &#123;</div><div class="line">            MessageDigest md5;</div><div class="line">            try &#123;</div><div class="line">                md5 = MessageDigest.getInstance(&quot;MD5&quot;);</div><div class="line">            &#125; catch (NoSuchAlgorithmException e) &#123;</div><div class="line">                throw new IllegalStateException(e.getMessage(), e);</div><div class="line">            &#125;</div><div class="line">            md5.reset();</div><div class="line">            byte[] bytes = null;</div><div class="line">            try &#123;</div><div class="line">                bytes = value.getBytes(&quot;UTF-8&quot;);</div><div class="line">            &#125; catch (UnsupportedEncodingException e) &#123;</div><div class="line">                throw new IllegalStateException(e.getMessage(), e);</div><div class="line">            &#125;</div><div class="line">            md5.update(bytes);</div><div class="line">            return md5.digest();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="其他技术细节或配置"><a href="#其他技术细节或配置" class="headerlink" title="其他技术细节或配置"></a>其他技术细节或配置</h4><blockquote>
<h5 id="动态代理方案对比："><a href="#动态代理方案对比：" class="headerlink" title="动态代理方案对比："></a>动态代理方案对比：</h5></blockquote>
<p><a href="http://javatar.iteye.com/blog/814426/" target="_blank" rel="external">梁飞-动态代理方案性能对比</a></p>
<blockquote>
<h5 id="配置尽量交给客户端配置原则-因为客户端更清楚调用耗时或者需求配置"><a href="#配置尽量交给客户端配置原则-因为客户端更清楚调用耗时或者需求配置" class="headerlink" title="配置尽量交给客户端配置原则(因为客户端更清楚调用耗时或者需求配置)"></a>配置尽量交给客户端配置原则(因为客户端更清楚调用耗时或者需求配置)</h5></blockquote>
<pre><code>timeout配置原则
</code></pre><blockquote>
<h5 id="拦截器扩展配置："><a href="#拦截器扩展配置：" class="headerlink" title="拦截器扩展配置："></a>拦截器扩展配置：</h5></blockquote>
<pre><code>服务提供方和服务消费方调用过程拦截，Dubbo本身的大多功能均基于此扩展点实现，
每次远程方法执行，该拦截都会被执行，请注意对性能的影响。参考dubbo拦截器扩展
</code></pre><blockquote>
<h5 id="暴露监听扩展配置："><a href="#暴露监听扩展配置：" class="headerlink" title="暴露监听扩展配置："></a>暴露监听扩展配置：</h5></blockquote>
<pre><code>当有服务暴露时，触发该事件。
</code></pre><blockquote>
<h5 id="集群扩展配置"><a href="#集群扩展配置" class="headerlink" title="集群扩展配置:"></a>集群扩展配置:</h5></blockquote>
<p>当有多个服务提供方时，将多个服务提供方组织成一个集群，并伪装成一个提供方。</p>
<pre><code>&lt;dubbo:protocol cluster=&quot;xxx&quot; /&gt;
&lt;dubbo:provider cluster=&quot;xxx&quot; /&gt; &lt;!-- 缺省值配置，如果&lt;dubbo:protocol&gt;没有配置cluster时，使用此配置 --&gt;    
com.alibaba.dubbo.rpc.cluster.support.FailoverCluster
com.alibaba.dubbo.rpc.cluster.support.FailfastCluster
com.alibaba.dubbo.rpc.cluster.support.FailsafeCluster
com.alibaba.dubbo.rpc.cluster.support.FailbackCluster
com.alibaba.dubbo.rpc.cluster.support.ForkingCluster
com.alibaba.dubbo.rpc.cluster.support.AvailableCluster
</code></pre><blockquote>
<h5 id="路由扩展扩展配置"><a href="#路由扩展扩展配置" class="headerlink" title="路由扩展扩展配置"></a>路由扩展扩展配置</h5></blockquote>
<p>从多个服务提者方中选择一个进行调用。</p>
<pre><code>&lt;dubbo:protocol router=&quot;xxx&quot; /&gt;
&lt;dubbo:provider router=&quot;xxx&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:protocol&gt;没有配置loadbalance时，使用此配置 --&gt;
com.alibaba.dubbo.rpc.cluster.router.ScriptRouterFactory    
com.alibaba.dubbo.rpc.cluster.router.FileRouterFactory
</code></pre><blockquote>
<h5 id="负载均衡扩展配置"><a href="#负载均衡扩展配置" class="headerlink" title="负载均衡扩展配置"></a>负载均衡扩展配置</h5></blockquote>
<p>从多个服务提者方中选择一个进行调用。</p>
<pre><code>&lt;dubbo:protocol loadbalance=&quot;xxx&quot; /&gt;
&lt;dubbo:provider loadbalance=&quot;xxx&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:protocol&gt;没有配置loadbalance时，使用此配置 --&gt;
com.alibaba.dubbo.rpc.cluster.loadbalance.RandomLoadBalance
com.alibaba.dubbo.rpc.cluster.loadbalance.RoundRobinLoadBalance
com.alibaba.dubbo.rpc.cluster.loadbalance.LeastActiveLoadBalance
</code></pre><blockquote>
<h5 id="注册中心扩展"><a href="#注册中心扩展" class="headerlink" title="注册中心扩展"></a>注册中心扩展</h5></blockquote>
<pre><code>&lt;dubbo:registry id=&quot;xxx1&quot; address=&quot;xxx://ip:port&quot; /&gt; &lt;!-- 定义注册中心 --&gt;
&lt;dubbo:service registry=&quot;xxx1&quot; /&gt; &lt;!-- 引用注册中心，如果没有配置registry属性，将在ApplicationContext中自动扫描registry配置 --&gt;
&lt;dubbo:provider registry=&quot;xxx1&quot; /&gt; &lt;!-- 引用注册中心缺省值，当&lt;dubbo:service&gt;没有配置registry属性时，使用此配置 --&gt;
com.alibaba.dubbo.registry.support.dubbo.DubboRegistryFactory
</code></pre><blockquote>
<h5 id="动态代理扩展-将Invoker接口转换成业务接口"><a href="#动态代理扩展-将Invoker接口转换成业务接口" class="headerlink" title="动态代理扩展:将Invoker接口转换成业务接口"></a>动态代理扩展:将Invoker接口转换成业务接口</h5></blockquote>
<pre><code>&lt;dubbo:protocol proxy=&quot;xxx&quot; /&gt;
&lt;dubbo:provider proxy=&quot;xxx&quot; /&gt; &lt;!-- 缺省值配置，当&lt;dubbo:protocol&gt;没有配置proxy属性时，使用此配置 --&gt;
com.alibaba.dubbo.rpc.proxy.JdkProxyFactory
com.alibaba.dubbo.rpc.proxy.JavassistProxyFactory
</code></pre><blockquote>
<h5 id="编译器扩展-Java代码编译器，用于动态生成字节码，加速调用。"><a href="#编译器扩展-Java代码编译器，用于动态生成字节码，加速调用。" class="headerlink" title="编译器扩展:Java代码编译器，用于动态生成字节码，加速调用。"></a>编译器扩展:Java代码编译器，用于动态生成字节码，加速调用。</h5></blockquote>
<pre><code>com.alibaba.dubbo.common.compiler.support.JdkCompiler
com.alibaba.dubbo.common.compiler.support.JavassistCompiler
</code></pre><blockquote>
<h5 id="消息派发扩展-通道信息派发器，用于指定线程池模型。"><a href="#消息派发扩展-通道信息派发器，用于指定线程池模型。" class="headerlink" title="消息派发扩展:通道信息派发器，用于指定线程池模型。"></a>消息派发扩展:通道信息派发器，用于指定线程池模型。</h5></blockquote>
<pre><code>&lt;dubbo:protocol dispatcher=&quot;xxx&quot; /&gt;
&lt;dubbo:provider dispatcher=&quot;xxx&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:protocol&gt;没有配置dispatcher属性时，使用此配置 --&gt;

com.alibaba.dubbo.remoting.transport.dispatcher.all.AllDispatcher
com.alibaba.dubbo.remoting.transport.dispatcher.direct.DirectDispatcher
com.alibaba.dubbo.remoting.transport.dispatcher.message.MessageOnlyDispatcher
com.alibaba.dubbo.remoting.transport.dispatcher.execution.ExecutionDispatcher
com.alibaba.dubbo.remoting.transport.dispatcher.connection.ConnectionOrderedDispatcher
</code></pre><blockquote>
<h5 id="线程池扩展"><a href="#线程池扩展" class="headerlink" title="线程池扩展:"></a>线程池扩展:</h5></blockquote>
<pre><code>服务提供方线程程实现策略，当服务器收到一个请求时，需要在线程池中创建一个线程去执行服务提供方业务逻辑。
&lt;dubbo:protocol threadpool=&quot;xxx&quot; /&gt;
&lt;dubbo:provider threadpool=&quot;xxx&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:protocol&gt;没有配置threadpool时，使用此配置 --&gt;
com.alibaba.dubbo.common.threadpool.FixedThreadPool
com.alibaba.dubbo.common.threadpool.CachedThreadPool
</code></pre><blockquote>
<h5 id="序列化扩展"><a href="#序列化扩展" class="headerlink" title="序列化扩展:"></a>序列化扩展:</h5></blockquote>
<p>将对象转成字节流，用于网络传输，以及将字节流转为对象，用于在收到字节流数据后还原成对象。</p>
<pre><code>&lt;dubbo:protocol serialization=&quot;xxx&quot; /&gt; &lt;!-- 协议的序列化方式 --&gt;
&lt;dubbo:provider serialization=&quot;xxx&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:protocol&gt;没有配置serialization时，使用此配置 --&gt;
com.alibaba.dubbo.common.serialize.dubbo.DubboSerialization
com.alibaba.dubbo.common.serialize.hessian.Hessian2Serialization
com.alibaba.dubbo.common.serialize.java.JavaSerialization
com.alibaba.dubbo.common.serialize.java.CompactedJavaSerialization
</code></pre><blockquote>
<h5 id="网络传输扩展"><a href="#网络传输扩展" class="headerlink" title="网络传输扩展:"></a>网络传输扩展:</h5></blockquote>
<p>远程通讯的服务器及客户端传输实现。</p>
<pre><code>&lt;dubbo:protocol transporter=&quot;xxx&quot; /&gt; &lt;!-- 服务器和客户端使用相同的传输实现 --&gt;
&lt;dubbo:protocol server=&quot;xxx&quot; client=&quot;xxx&quot; /&gt; &lt;!-- 服务器和客户端使用不同的传输实现 --&gt;
&lt;dubbo:provider transporter=&quot;xxx&quot; server=&quot;xxx&quot; client=&quot;xxx&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:protocol&gt;没有配置transporter/server/client属性时，使用此配置 --&gt;

com.alibaba.dubbo.remoting.transport.transporter.netty.NettyTransporter
com.alibaba.dubbo.remoting.transport.transporter.mina.MinaTransporter
com.alibaba.dubbo.remoting.transport.transporter.grizzly.GrizzlyTransporter
</code></pre><blockquote>
<h5 id="信息交换扩展"><a href="#信息交换扩展" class="headerlink" title="信息交换扩展:"></a>信息交换扩展:</h5></blockquote>
<p>基于传输层之上，实现Request-Response信息交换语义。</p>
<pre><code>&lt;dubbo:protocol exchanger=&quot;xxx&quot; /&gt;
&lt;dubbo:provider exchanger=&quot;xxx&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:protocol&gt;没有配置exchanger属性时，使用此配置 --&gt;
com.alibaba.dubbo.remoting.exchange.Exchanger
com.alibaba.dubbo.remoting.exchange.ExchangeServer
com.alibaba.dubbo.remoting.exchange.ExchangeClient
</code></pre><blockquote>
<h5 id="容器扩展-服务容器扩展，用于自定义加载内容。"><a href="#容器扩展-服务容器扩展，用于自定义加载内容。" class="headerlink" title="容器扩展:服务容器扩展，用于自定义加载内容。"></a>容器扩展:服务容器扩展，用于自定义加载内容。</h5></blockquote>
<pre><code>java com.alibaba.dubbo.container.Main spring jetty log4j

com.alibaba.dubbo.container.spring.SpringContainer
com.alibaba.dubbo.container.spring.JettyContainer
com.alibaba.dubbo.container.spring.Log4jContainer
</code></pre><blockquote>
<h5 id="验证扩展-参数验证扩展点。"><a href="#验证扩展-参数验证扩展点。" class="headerlink" title="验证扩展:参数验证扩展点。"></a>验证扩展:参数验证扩展点。</h5></blockquote>
<pre><code>&lt;dubbo:service validation=&quot;xxx,yyy&quot; /&gt;
&lt;dubbo:provider validation=&quot;xxx,yyy&quot; /&gt; &lt;!-- 缺省值设置，当&lt;dubbo:service&gt;没有配置validation属性时，使用此配置 --&gt;
com.alibaba.dubbo.validation.support.jvalidation.JValidation
</code></pre><blockquote>
<h5 id="日志适配扩展"><a href="#日志适配扩展" class="headerlink" title="日志适配扩展:"></a>日志适配扩展:</h5></blockquote>
<pre><code>&lt;dubbo:application logger=&quot;xxx&quot; /&gt;
-Ddubbo:application.logger=xxx

slf4j=com.alibaba.dubbo.common.logger.slf4j.Slf4jLoggerAdapter
jcl=com.alibaba.dubbo.common.logger.jcl.JclLoggerAdapter
log4j=com.alibaba.dubbo.common.logger.log4j.Log4jLoggerAdapter
jdk=com.alibaba.dubbo.common.logger.jdk.JdkLoggerAdapter
</code></pre><blockquote>
<h3 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h3><p>服务端部署</p>
<p>监控中心</p>
</blockquote>
<h2 id="dubbo源码分析"><a href="#dubbo源码分析" class="headerlink" title="dubbo源码分析"></a>dubbo源码分析</h2><blockquote>
<h3 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.URL;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.extension.Adaptive;</div><div class="line"><span class="keyword">import</span> com.alibaba.dubbo.common.extension.SPI;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Protocol. (API/SPI, Singleton, ThreadSafe)</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * <span class="doctag">@author</span> william.liangf</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="meta">@SPI</span>(<span class="string">"dubbo"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 获取缺省端口，当用户没有配置端口时使用。</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> 缺省端口</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 暴露远程服务：&lt;br&gt;  --服务端</span></div><div class="line"><span class="comment">     * 1. 协议在接收请求时，应记录请求来源方地址信息：RpcContext.getContext().setRemoteAddress();&lt;br&gt;</span></div><div class="line"><span class="comment">     * 2. export()必须是</span></div><div class="line"><span class="comment">     * 的，也就是暴露同一个URL的Invoker两次，和暴露一次没有区别。&lt;br&gt;</span></div><div class="line"><span class="comment">     * 3. export()传入的Invoker由框架实现并传入，协议不需要关心。&lt;br&gt;</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 服务的类型</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> invoker 服务的执行体</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> exporter 暴露服务的引用，用于取消暴露</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> RpcException 当暴露服务出错时抛出，比如端口已占用</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Adaptive</span></div><div class="line">    &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 引用远程服务：&lt;br&gt;  --客户端</span></div><div class="line"><span class="comment">     * 1. 当用户调用refer()所返回的Invoker对象的invoke()方法时，协议需相应执行同URL远端export()传入的Invoker对象的invoke()方法。&lt;br&gt;</span></div><div class="line"><span class="comment">     * 2. refer()返回的Invoker由协议实现，协议通常需要在此Invoker中发送远程请求。&lt;br&gt;</span></div><div class="line"><span class="comment">     * 3. 当url中有设置check=false时，连接失败不能抛出异常，并内部自动恢复。&lt;br&gt;</span></div><div class="line"><span class="comment">     * </span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 服务的类型</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> type 服务的类型</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> url 远程服务的URL地址</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span> invoker 服务的本地代理</span></div><div class="line"><span class="comment">     * <span class="doctag">@throws</span> RpcException 当连接服务提供方失败时抛出</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="meta">@Adaptive</span></div><div class="line">    &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 释放协议：&lt;br&gt;</span></div><div class="line"><span class="comment">     * 1. 取消该协议所有已经暴露和引用的服务。&lt;br&gt;</span></div><div class="line"><span class="comment">     * 2. 释放协议所占用的所有资源，比如连接和端口。&lt;br&gt;</span></div><div class="line"><span class="comment">     * 3. 协议在释放后，依然能暴露和引用新的服务。&lt;br&gt;</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Exporter-Invoker-Protocol之间关系"><a href="#Exporter-Invoker-Protocol之间关系" class="headerlink" title="Exporter,Invoker,Protocol之间关系"></a>Exporter,Invoker,Protocol之间关系</h3><p>例如：dubboProtocol <code>implements</code> Protocol<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>.暴露服务接口操作，同一接口 暴露多次和一次是一样的，需实现幂等操作，ConcurrentHashMap</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ExchangeServer&gt; serverMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ExchangeServer&gt;(); <span class="comment">// &lt;host:port,Exchanger&gt;</span></div><div class="line">   </div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>&#123;</div><div class="line">       URL url = invoker.getUrl();</div><div class="line">       </div><div class="line">       <span class="comment">// export service.  暴露的服务端的url地址，会缓存到exporterMap中</span></div><div class="line">       String key = serviceKey(url);</div><div class="line">       DubboExporter&lt;T&gt; exporter = <span class="keyword">new</span> DubboExporter&lt;T&gt;(invoker, key, exporterMap);</div><div class="line">       exporterMap.put(key, exporter);</div><div class="line">       </div><div class="line">       <span class="comment">//export an stub service for dispaching event</span></div><div class="line">       Boolean isStubSupportEvent = url.getParameter(Constants.STUB_EVENT_KEY,Constants.DEFAULT_STUB_EVENT);</div><div class="line">       Boolean isCallbackservice = url.getParameter(Constants.IS_CALLBACK_SERVICE, <span class="keyword">false</span>);</div><div class="line">       <span class="keyword">if</span> (isStubSupportEvent &amp;&amp; !isCallbackservice)&#123;</div><div class="line">           String stubServiceMethods = url.getParameter(Constants.STUB_EVENT_METHODS_KEY);</div><div class="line">           <span class="keyword">if</span> (stubServiceMethods == <span class="keyword">null</span> || stubServiceMethods.length() == <span class="number">0</span> )&#123;</div><div class="line">               <span class="keyword">if</span> (logger.isWarnEnabled())&#123;</div><div class="line">                   logger.warn(<span class="keyword">new</span> IllegalStateException(<span class="string">"consumer ["</span> +url.getParameter(Constants.INTERFACE_KEY) +</div><div class="line">                           <span class="string">"], has set stubproxy support event ,but no stub methods founded."</span>));</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               stubServiceMethodsMap.put(url.getServiceKey(), stubServiceMethods);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//暴露 server</span></div><div class="line">       openServer(url);</div><div class="line">       </div><div class="line">       <span class="keyword">return</span> exporter;</div><div class="line">   &#125;</div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openServer</span><span class="params">(URL url)</span> </span>&#123;</div><div class="line">       <span class="comment">// find server.    cache key规则：port &lt;= 0 ? host : host + ":" + port</span></div><div class="line">       String key = url.getAddress();</div><div class="line">       <span class="comment">//client 也可以暴露一个只有server可以调用的服务。</span></div><div class="line">       <span class="keyword">boolean</span> isServer = url.getParameter(Constants.IS_SERVER_KEY,<span class="keyword">true</span>);</div><div class="line">       <span class="keyword">if</span> (isServer) &#123;</div><div class="line">       	ExchangeServer server = serverMap.get(key);</div><div class="line">       	<span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</div><div class="line">       		serverMap.put(key, createServer(url));</div><div class="line">       	&#125; <span class="keyword">else</span> &#123;</div><div class="line">       		<span class="comment">//server支持reset,配合override功能使用</span></div><div class="line">       		server.reset(url);</div><div class="line">       	&#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="number">2</span>.客户端转换invoker操作</div><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; serviceType, URL url)</span> <span class="keyword">throws</span> RpcException </span>&#123;</div><div class="line">       <span class="comment">// create rpc invoker.</span></div><div class="line">       DubboInvoker&lt;T&gt; invoker = <span class="keyword">new</span> DubboInvoker&lt;T&gt;(serviceType, url, getClients(url), invokers);</div><div class="line">       invokers.add(invoker);</div><div class="line">       <span class="keyword">return</span> invoker;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="线程池配置-Dispatcher-spi"><a href="#线程池配置-Dispatcher-spi" class="headerlink" title="线程池配置 Dispatcher spi"></a>线程池配置 Dispatcher spi</h3></blockquote>
<ul>
<li>protocolConfig配置 protocol参数配置</li>
</ul>
<h2 id="dubbo遇到问题"><a href="#dubbo遇到问题" class="headerlink" title="dubbo遇到问题"></a>dubbo遇到问题</h2><blockquote>
<h3 id="dubbo-xsd导入问题？"><a href="#dubbo-xsd导入问题？" class="headerlink" title="dubbo.xsd导入问题？"></a>dubbo.xsd导入问题？</h3></blockquote>
<p>dubbo.xsd失效在eclipse配置全局</p>
<p>参考：<a href="dubbo.xsd问题">http://blog.csdn.net/gaoshanliushui2009/article/details/50469595</a></p>
<blockquote>
<h3 id="dubbo如何实现graceful关闭服务url和启动延迟暴露"><a href="#dubbo如何实现graceful关闭服务url和启动延迟暴露" class="headerlink" title="dubbo如何实现graceful关闭服务url和启动延迟暴露?"></a>dubbo如何实现graceful关闭服务url和启动延迟暴露?</h3></blockquote>
<p>Dubbo是通过JDK的ShutdownHook来完成优雅停机的，所以如果用户使用”kill -9 PID”等强制关闭指令，是不会执行优雅停机的，只有通过”kill PID”时，才会执行。</p>
<p>原理：</p>
<pre><code>服务提供方
    停止时，先标记为不接收新请求，新请求过来时直接报错，让客户端重试其它机器。
    然后，检测线程池中的线程是否正在运行，如果有，等待所有线程执行完成，除非超时，则强制关闭。
服务消费方
    停止时，不再发起新的调用请求，所有新的调用在客户端即报错。
    然后，检测有没有请求的响应还没有返回，等待响应返回，除非超时，则强制关闭。
</code></pre><p>设置优雅停机超时时间，缺省超时时间是10秒：(超时则强制关闭)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">bash</div><div class="line"></div><div class="line">	echo -e &quot;Stopping the $SERVER_NAME ...\c&quot;</div><div class="line">	for PID in $PIDS ; do</div><div class="line">	    kill $PID &gt; /dev/null 2&gt;&amp;1</div><div class="line">	done</div><div class="line">	</div><div class="line">	COUNT=0</div><div class="line">	while [ $COUNT -lt 1 ]; do    </div><div class="line">	    echo -e &quot;.\c&quot;</div><div class="line">	    sleep 1</div><div class="line">	    COUNT=1</div><div class="line">	    for PID in $PIDS ; do</div><div class="line">	        PID_EXIST=`ps -f -p $PID | grep java`</div><div class="line">	        if [ -n &quot;$PID_EXIST&quot; ]; then</div><div class="line">	            COUNT=0</div><div class="line">	            break</div><div class="line">	        fi</div><div class="line">	    done</div><div class="line">	done</div><div class="line">	</div><div class="line">	echo &quot;OK!&quot;</div><div class="line">	echo &quot;PID: $PIDS&quot;</div></pre></td></tr></table></figure></p>
<p>url线程中断：Graceful close the channel<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractServer</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span> <span class="keyword">implements</span> <span class="title">Server</span></span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>&#123;</div><div class="line">        ExecutorUtil.gracefulShutdown(executor ,timeout);</div><div class="line">        close();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ExecutorUtil.java</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gracefulShutdown</span><span class="params">(Executor executor, <span class="keyword">int</span> timeout)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (!(executor <span class="keyword">instanceof</span> ExecutorService) || isShutdown(executor)) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">final</span> ExecutorService es = (ExecutorService) executor;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           es.shutdown(); <span class="comment">// Disable new tasks from being submitted</span></div><div class="line">       &#125; <span class="keyword">catch</span> (SecurityException ex2) &#123;</div><div class="line">           <span class="keyword">return</span> ;</div><div class="line">       &#125; <span class="keyword">catch</span> (NullPointerException ex2) &#123;</div><div class="line">           <span class="keyword">return</span> ;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">if</span>(! es.awaitTermination(timeout, TimeUnit.MILLISECONDS)) &#123;</div><div class="line">               es.shutdownNow();</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line">           es.shutdownNow();</div><div class="line">           Thread.currentThread().interrupt();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!isShutdown(es))&#123;</div><div class="line">           newThreadToCloseExecutor(es);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<h3 id="dubbo如何实现客户端请求timeout"><a href="#dubbo如何实现客户端请求timeout" class="headerlink" title="dubbo如何实现客户端请求timeout"></a>dubbo如何实现客户端请求timeout</h3><p>最终由provider返回给客户端：线程池等待时间返回给客户端状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">//超时异常服务端返回</div><div class="line">/**</div><div class="line"> * DefaultFuture.</div><div class="line"> * </div><div class="line"> * @author qian.lei</div><div class="line"> * @author chao.liuc</div><div class="line"> */</div><div class="line">public class DefaultFuture implements ResponseFuture &#123;</div><div class="line">	private static final Map&lt;Long, Channel&gt;       CHANNELS   = new ConcurrentHashMap&lt;Long, Channel&gt;();</div><div class="line"></div><div class="line">    private static final Map&lt;Long, DefaultFuture&gt; FUTURES   = new ConcurrentHashMap&lt;Long, DefaultFuture&gt;();</div><div class="line"></div><div class="line">    // invoke id.</div><div class="line">    private final long                            id;</div><div class="line"></div><div class="line">    private final Channel                         channel;</div><div class="line">    </div><div class="line">    private final Request                         request;</div><div class="line"></div><div class="line">    private final int                             timeout;</div><div class="line"></div><div class="line">    private final Lock                            lock = new ReentrantLock();</div><div class="line"></div><div class="line">    private final Condition                       done = lock.newCondition();</div><div class="line"></div><div class="line">    private final long                            start = System.currentTimeMillis();</div><div class="line"></div><div class="line">    private volatile long                         sent;</div><div class="line">    </div><div class="line">    private volatile Response                     response;</div><div class="line"></div><div class="line">    private volatile ResponseCallback             callback;</div><div class="line"></div><div class="line">	public Object get(int timeout) throws RemotingException &#123;</div><div class="line">        if (timeout &lt;= 0) &#123;</div><div class="line">            timeout = Constants.DEFAULT_TIMEOUT;</div><div class="line">        &#125;</div><div class="line">        if (! isDone()) &#123;</div><div class="line">            long start = System.currentTimeMillis();</div><div class="line">            lock.lock();</div><div class="line">            try &#123;</div><div class="line">                while (! isDone()) &#123;</div><div class="line">					//condition实现</div><div class="line">                    **done.await(timeout, timeunit.milliseconds);**</div><div class="line">                    if (isDone() || System.currentTimeMillis() - start &gt; timeout) &#123;</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                throw new RuntimeException(e);</div><div class="line">            &#125; finally &#123;</div><div class="line">                lock.unlock();</div><div class="line">            &#125;</div><div class="line">            if (! isDone()) &#123;</div><div class="line">                throw new TimeoutException(sent &gt; 0, channel, getTimeoutMessage(false));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return returnFromResponse();</div><div class="line">    &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 如果执行timeout，则log记录下，不干涉服务的运行</div><div class="line"> * </div><div class="line"> * @author chao.liuc</div><div class="line"> */</div><div class="line">@Activate(group = Constants.PROVIDER)</div><div class="line">public class TimeoutFilter implements Filter &#123;</div><div class="line"></div><div class="line">    private static final Logger logger = LoggerFactory.getLogger(TimeoutFilter.class);</div><div class="line"></div><div class="line">    public Result invoke(Invoker&lt;?&gt; invoker, Invocation invocation) throws RpcException &#123;</div><div class="line">        long start = System.currentTimeMillis();</div><div class="line">        Result result = invoker.invoke(invocation);</div><div class="line">        long elapsed = System.currentTimeMillis() - start;</div><div class="line">        if (invoker.getUrl() != null</div><div class="line">                &amp;&amp; elapsed &gt; invoker.getUrl().getMethodParameter(invocation.getMethodName(),</div><div class="line">                        &quot;timeout&quot;, Integer.MAX_VALUE)) &#123;</div><div class="line">            if (logger.isWarnEnabled()) &#123;</div><div class="line">                logger.warn(&quot;invoke time out. method: &quot; + invocation.getMethodName()</div><div class="line">                        + &quot;arguments: &quot; + Arrays.toString(invocation.getArguments()) + &quot; , url is &quot;</div><div class="line">                        + invoker.getUrl() + &quot;, invoke elapsed &quot; + elapsed + &quot; ms.&quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<h3 id="线程池改造"><a href="#线程池改造" class="headerlink" title="线程池改造"></a>线程池改造</h3></blockquote>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/rpc/" rel="tag">#rpc</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/14/(6.4).系统故障-单点方案/" rel="next" title="系统单点故障预案">
                <i class="fa fa-chevron-left"></i> 系统单点故障预案
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/02/(7.4).分布式架构-elasticSearch/" rel="prev" title="elasticsearch">
                elasticsearch <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/metor.ico"
               alt="Pedestrian" />
          <p class="site-author-name" itemprop="name">Pedestrian</p>
          <p class="site-description motion-element" itemprop="description">study for goal</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">46</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/yanan0628" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://carlosfu.github.io/" target="_blank" title="fudada">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  fudada
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://jolinzhangg.github.io/" target="_blank" title="xiaodada">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  xiaodada
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#dubbo架构原理"><span class="nav-number">1.</span> <span class="nav-text">dubbo架构原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#框架设计"><span class="nav-number">1.1.</span> <span class="nav-text">框架设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖关系"><span class="nav-number">1.2.</span> <span class="nav-text">依赖关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调用链"><span class="nav-number">1.3.</span> <span class="nav-text">调用链</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dubbo使用原理"><span class="nav-number">2.</span> <span class="nav-text">dubbo使用原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#源码接入方式"><span class="nav-number">2.1.</span> <span class="nav-text">源码接入方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于扩展点SPI支持"><span class="nav-number">2.2.</span> <span class="nav-text">基于扩展点SPI支持</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SPI规范"><span class="nav-number">2.2.1.</span> <span class="nav-text">SPI规范</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#spi实现方式"><span class="nav-number">2.2.2.</span> <span class="nav-text">spi实现方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#项目使用spi配置"><span class="nav-number">2.2.3.</span> <span class="nav-text">项目使用spi配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务配置"><span class="nav-number">2.3.</span> <span class="nav-text">服务配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#解析服务"><span class="nav-number">2.3.1.</span> <span class="nav-text">解析服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#暴露服务"><span class="nav-number">2.3.2.</span> <span class="nav-text">暴露服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#引用服务"><span class="nav-number">2.3.3.</span> <span class="nav-text">引用服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通讯细节-IO-线程池"><span class="nav-number">2.3.4.</span> <span class="nav-text">通讯细节/IO,线程池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群相关"><span class="nav-number">2.3.5.</span> <span class="nav-text">集群相关</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#集群调用模型图："><span class="nav-number">2.3.5.1.</span> <span class="nav-text">集群调用模型图：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#集群容错"><span class="nav-number">2.3.5.2.</span> <span class="nav-text">集群容错</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#负载均衡"><span class="nav-number">2.3.5.3.</span> <span class="nav-text">负载均衡</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他技术细节或配置"><span class="nav-number">2.3.6.</span> <span class="nav-text">其他技术细节或配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#动态代理方案对比："><span class="nav-number">2.3.6.1.</span> <span class="nav-text">动态代理方案对比：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#配置尽量交给客户端配置原则-因为客户端更清楚调用耗时或者需求配置"><span class="nav-number">2.3.6.2.</span> <span class="nav-text">配置尽量交给客户端配置原则(因为客户端更清楚调用耗时或者需求配置)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#拦截器扩展配置："><span class="nav-number">2.3.6.3.</span> <span class="nav-text">拦截器扩展配置：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#暴露监听扩展配置："><span class="nav-number">2.3.6.4.</span> <span class="nav-text">暴露监听扩展配置：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#集群扩展配置"><span class="nav-number">2.3.6.5.</span> <span class="nav-text">集群扩展配置:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#路由扩展扩展配置"><span class="nav-number">2.3.6.6.</span> <span class="nav-text">路由扩展扩展配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#负载均衡扩展配置"><span class="nav-number">2.3.6.7.</span> <span class="nav-text">负载均衡扩展配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#注册中心扩展"><span class="nav-number">2.3.6.8.</span> <span class="nav-text">注册中心扩展</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#动态代理扩展-将Invoker接口转换成业务接口"><span class="nav-number">2.3.6.9.</span> <span class="nav-text">动态代理扩展:将Invoker接口转换成业务接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#编译器扩展-Java代码编译器，用于动态生成字节码，加速调用。"><span class="nav-number">2.3.6.10.</span> <span class="nav-text">编译器扩展:Java代码编译器，用于动态生成字节码，加速调用。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#消息派发扩展-通道信息派发器，用于指定线程池模型。"><span class="nav-number">2.3.6.11.</span> <span class="nav-text">消息派发扩展:通道信息派发器，用于指定线程池模型。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#线程池扩展"><span class="nav-number">2.3.6.12.</span> <span class="nav-text">线程池扩展:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#序列化扩展"><span class="nav-number">2.3.6.13.</span> <span class="nav-text">序列化扩展:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#网络传输扩展"><span class="nav-number">2.3.6.14.</span> <span class="nav-text">网络传输扩展:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#信息交换扩展"><span class="nav-number">2.3.6.15.</span> <span class="nav-text">信息交换扩展:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#容器扩展-服务容器扩展，用于自定义加载内容。"><span class="nav-number">2.3.6.16.</span> <span class="nav-text">容器扩展:服务容器扩展，用于自定义加载内容。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#验证扩展-参数验证扩展点。"><span class="nav-number">2.3.6.17.</span> <span class="nav-text">验证扩展:参数验证扩展点。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#日志适配扩展"><span class="nav-number">2.3.6.18.</span> <span class="nav-text">日志适配扩展:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务部署"><span class="nav-number">2.4.</span> <span class="nav-text">服务部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dubbo源码分析"><span class="nav-number">3.</span> <span class="nav-text">dubbo源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Protocol"><span class="nav-number">3.1.</span> <span class="nav-text">Protocol</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Exporter-Invoker-Protocol之间关系"><span class="nav-number">3.2.</span> <span class="nav-text">Exporter,Invoker,Protocol之间关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程池配置-Dispatcher-spi"><span class="nav-number">3.3.</span> <span class="nav-text">线程池配置 Dispatcher spi</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dubbo遇到问题"><span class="nav-number">4.</span> <span class="nav-text">dubbo遇到问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dubbo-xsd导入问题？"><span class="nav-number">4.1.</span> <span class="nav-text">dubbo.xsd导入问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dubbo如何实现graceful关闭服务url和启动延迟暴露"><span class="nav-number">4.2.</span> <span class="nav-text">dubbo如何实现graceful关闭服务url和启动延迟暴露?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dubbo如何实现客户端请求timeout"><span class="nav-number">4.3.</span> <span class="nav-text">dubbo如何实现客户端请求timeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#线程池改造"><span class="nav-number">4.4.</span> <span class="nav-text">线程池改造</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pedestrian</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
